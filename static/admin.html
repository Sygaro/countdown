<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Countdown · Admin</title>
  <link rel="stylesheet" href="/static/css/ui.css"/>
  <style>
    .actions { position: sticky; top: 0; z-index: 5; padding: 10px 16px; background: rgba(11,15,20,.85); backdrop-filter: blur(8px); border-bottom:1px solid var(--border); display:flex; gap:8px; align-items:center }
    .pill { padding:4px 8px; border-radius:999px; font-size:.85rem; border:1px solid var(--border); }
    .ok { color:#0b0f14; background:#69db7c; border-color:transparent; }
    .warn { color:#0b0f14; background:#ffd166; border-color:transparent; }
    .off { color:#e6edf3; background:#374151; }
    .row { display:flex; flex-wrap:wrap; gap:10px; align-items:center }
    .hint-inline { font-size:.85rem; opacity:.9; margin-left:6px }
    .preview { background:#0b0f14;border:1px solid var(--border); border-radius:12px; padding:14px; min-height:200px; display:flex; align-items:center; justify-content:center }
    .pv-box { width:100%; max-width:800px; aspect-ratio: 16/8; border:1px solid var(--border); border-radius:10px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; padding:10px; }
    .pv-digits { font-weight:800; letter-spacing:.06em; font-size: clamp(4vw, 8vw, 10vw); }
    .tag { font-size:.8rem; color:var(--muted); border:1px dashed var(--border); padding:2px 6px; border-radius:6px }
  </style>
</head>
<body>
  <header>
    <h1>Countdown · Admin</h1>
    <nav>
      <a href="/">Visning</a>
      <a class="active" href="/admin">Admin</a>
      <a href="/diag">Diagnose</a>
      <a href="/about">Om</a>
    </nav>
  </header>

  <div class="actions">
    <button id="btn_save" class="primary" title="Lagre endringer">Lagre</button>
    <button id="btn_refresh" title="Hent status fra server">Oppdater</button>
    <button id="btn_reset_view" title="Tilbakestill (defaults fra server)">Tilbakestill visning</button>
    <span id="sync_pill" class="pill off">Synk: —</span>
    <span id="save_hint" class="muted"></span>
  </div>

  <main class="grid">
    <!-- Modus -->
    <section class="card">
      <h2>Modus</h2>
      <label title="Teller ned til fast klokkeslett"><input type="radio" name="mode" value="daily"/> Daglig klokkeslett</label>
      <input id="daily_time" type="time" step="60"/>
      <br/>
      <label title="Teller ned til ett bestemt tidspunkt"><input type="radio" name="mode" value="once"/> Engangs-tidspunkt</label>
      <input id="once_at" type="datetime-local"/>
      <br/>
      <label title="Manuell varighetsnedtelling"><input type="radio" name="mode" value="duration"/> Varighet (manuell start)</label>
      <br/>
      <label title="Vis ren stopp-skjerm (tekst/bilde/blackout)"><input type="radio" name="mode" value="screen"/> Stopp-skjerm</label>
      <p class="hint">Velg én modus. Lagre for at endring skal gjelde.</p>
      <p id="active_mode" class="muted">Aktiv modus: —</p>
    </section>

    <!-- Start med varighet -->
    <section class="card">
      <h2>Start med varighet</h2>
      <div class="row">
        <button class="preset" data-min="5">+5 min</button>
        <button class="preset" data-min="10">+10 min</button>
        <button class="preset" data-min="15">+15 min</button>
        <button class="preset" data-min="30">+30 min</button>
        <label>Varighet (minutter) <input id="start_minutes" type="number" min="1" step="1" value="10"/></label>
        <button id="btn_start" class="primary">Start nedtelling nå</button>
        <button id="btn_stop">Stopp</button>
      </div>
      <p class="hint">Starter alltid varighetsmodus umiddelbart.</p>
    </section>

    <!-- Stopp-skjerm -->
    <section class="card">
      <h2>Stopp-skjerm</h2>
      <label><input type="radio" name="screen_type" value="text"/> Tekst</label>
      <label><input type="radio" name="screen_type" value="image"/> Bilde</label>
      <label><input type="radio" name="screen_type" value="blackout"/> Blackout</label>
      <div id="screen_text_cfg">
        <label>Tekst <input id="screen_text" type="text" placeholder="Pause"/></label>
        <label>Tekstfarge <input id="screen_text_color" type="color" value="#ffffff"/></label>
        <label>Bakgrunn <input id="screen_bg" type="color" value="#000000"/></label>
        <label>Skriftstørrelse (vh) <input id="screen_font_vh" type="number" min="4" max="30" step="1" value="10"/></label>
      </div>
      <div id="screen_image_cfg">
        <label>Bilde-URL <input id="screen_image_url" type="url" placeholder="https://..."/></label>
        <label>Opacity (0–100) <input id="screen_image_opacity" type="number" min="0" max="100" step="1" value="100"/></label>
        <label>Tilpasning
          <select id="screen_image_fit"><option value="cover">cover</option><option value="contain">contain</option></select>
        </label>
        <label>Bakgrunn <input id="screen_bg_img" type="color" value="#000000"/></label>
      </div>
      <p class="hint">Gjelder når modus = Stopp-skjerm.</p>
    </section>

    <!-- Visning / oppførsel -->
    <section class="card">
      <h2>Visning / oppførsel</h2>
      <div class="help">Terskel: ved ≥ verdi vises <strong>H:MM:SS</strong>, ellers <strong>MM:SS</strong> (70→2:00:00, 300→120:00).</div>
      <label><input id="use_phase_colors" type="checkbox"/> Fargelegg ved gult/rødt</label>
      <label><input id="use_blink" type="checkbox"/> Blink de siste sekundene</label>

      <div class="row">
        <label>Farge normal <input id="color_normal" type="color" value="#e6edf3"/></label><span id="c_contrast_normal" class="hint-inline"></span>
      </div>
      <div class="row">
        <label>Farge gul <input id="color_warn" type="color" value="#ffd166"/></label><span id="c_contrast_warn" class="hint-inline"></span>
      </div>
      <div class="row">
        <label>Farge rød <input id="color_alert" type="color" value="#ff6b6b"/></label><span id="c_contrast_alert" class="hint-inline"></span>
      </div>
      <div class="row">
        <label>Farge minus-tid <input id="color_over" type="color" value="#9ad0ff"/></label><span id="c_contrast_over" class="hint-inline"></span>
      </div>

      <label><input id="show_target_time" type="checkbox"/> Vis mål-klokkeslett</label>
      <label>Plassering av mål-klokkeslett
        <select id="target_time_after"><option value="primary">etter hovedmelding</option><option value="secondary">etter sekundær melding</option></select>
      </label>
      <label>Plassering av meldinger
        <select id="messages_position"><option value="above">over nedtellingen</option><option value="below">under nedtellingen</option></select>
      </label>
      <label>Tidsformat → H:MM:SS når over (min)
        <input id="hms_threshold_minutes" type="number" min="0" max="720" step="1" value="60"/>
      </label>
    </section>

    <!-- Utseende – Meldinger -->
    <section class="card">
      <h2>Utseende – Meldinger</h2>
      <div class="row">
        <strong>Hovedmelding</strong>
        <label>Størrelse (rem) <input id="theme_p_size" type="number" step="0.1" min="0.6" max="3.0"/></label>
        <label>Vekt
          <select id="theme_p_weight"><option>300</option><option>400</option><option>500</option><option selected>600</option><option>700</option><option>800</option><option>900</option></select>
        </label>
        <label>Farge <input id="theme_p_color" type="color"/></label>
        <span id="m_contrast_p" class="hint-inline tag"></span>
      </div>
      <div class="row">
        <strong>Sekundær</strong>
        <label>Størrelse (rem) <input id="theme_s_size" type="number" step="0.1" min="0.6" max="3.0"/></label>
        <label>Vekt
          <select id="theme_s_weight"><option>300</option><option selected>400</option><option>500</option><option>600</option><option>700</option><option>800</option><option>900</option></select>
        </label>
        <label>Farge <input id="theme_s_color" type="color"/></label>
        <span id="m_contrast_s" class="hint-inline tag"></span>
      </div>
      <div class="row">
        <strong>Digits</strong>
        <label>Størrelse
          <select id="digits_size_preset">
            <option value="14">Normal</option><option value="18">Stor</option><option value="22">Ekstra stor</option>
          </select>
        </label>
      </div>
    </section>

    <!-- Utseende – Bakgrunn -->
    <section class="card">
      <h2>Utseende – Bakgrunn</h2>
      <label><input type="radio" name="bg_mode" value="solid"/> Ensfarget</label>
      <label><input type="radio" name="bg_mode" value="gradient"/> Gradient</label>
      <label><input type="radio" name="bg_mode" value="image"/> Bilde</label>

      <div id="bg_solid_cfg">
        <label>Farge <input id="bg_solid_color" type="color" value="#0b0f14"/></label>
      </div>
      <div id="bg_grad_cfg">
        <label>Fra <input id="bg_grad_from" type="color" value="#142033"/></label>
        <label>Til <input id="bg_grad_to" type="color" value="#0b0f14"/></label>
        <label>Vinkel (°) <input id="bg_grad_angle" type="number" min="0" max="360" step="1" value="180"/></label>
      </div>
      <div id="bg_img_cfg">
        <label>Bilde-URL <input id="bg_img_url" type="url" placeholder="https://..."/></label>
        <label>Fit
          <select id="bg_img_fit"><option>cover</option><option>contain</option></select>
        </label>
        <label>Opacity (0–1) <input id="bg_img_op" type="number" min="0" max="1" step="0.05" value="1"/></label>
        <label>Tint-farge <input id="bg_img_tint" type="color" value="#000000"/></label>
        <label>Tint-opacity (0–1) <input id="bg_img_tint_op" type="number" min="0" max="1" step="0.05" value="0"/></label>
      </div>
    </section>

    <!-- Forhåndsvisning -->
    <section class="card">
      <h2>Forhåndsvisning</h2>
      <div class="row">
        <span class="tag">Simuler:</span>
        <label><input type="radio" name="pv_state" value="normal" checked/> Normal</label>
        <label><input type="radio" name="pv_state" value="warn"/> Gul</label>
        <label><input type="radio" name="pv_state" value="alert"/> Rød</label>
        <label><input type="radio" name="pv_state" value="overrun"/> Minus-tid</label>
        <label><input type="checkbox" id="pv_blink"/> Blink</label>
      </div>
      <div id="preview" class="preview">
        <div id="pv_box" class="pv-box" style="background:#0b0f14">
          <div id="pv_above" style="display:none;text-align:center">
            <div id="pv_prim_above"></div><div id="pv_sec_above"></div>
          </div>
          <div id="pv_digits" class="pv-digits">12:34</div>
          <div id="pv_below" style="display:block;text-align:center">
            <div id="pv_prim_below"></div><div id="pv_sec_below"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
  (function(){
    const $ = s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
    const pill=$("#sync_pill"); const hint=$("#save_hint");
    let lastCfg=null, defaultsCache=null;

    function headers(){ const pwd=($("#admin_password")?.value||"").trim(); const h={"Content-Type":"application/json"}; if(pwd) h["X-Admin-Password"]=pwd; return h; }
    function selMode(){ const r=$$("input[name=mode]:checked")[0]; return r? r.value : "daily"; }
    function selBgMode(){ const r=$$("input[name=bg_mode]:checked")[0]; return r? r.value : "solid"; }
    function lock(){
      const m=selMode();
      $("#daily_time").disabled=(m!=="daily"); $("#once_at").disabled=(m!=="once");
      const st=(m==="screen"); $("#screen_text_cfg").style.display = st ? "block":"none"; $("#screen_image_cfg").style.display = st ? "block":"none";
      const bg=selBgMode();
      $("#bg_solid_cfg").style.display = bg==="solid"?"block":"none";
      $("#bg_grad_cfg").style.display  = bg==="gradient"?"block":"none";
      $("#bg_img_cfg").style.display   = bg==="image"?"block":"none";
    }
    function pulse(el){ if(!el) return; el.classList.remove("pulse"); void el.offsetWidth; el.classList.add("pulse"); }

    // kontrast
    const hexToRgb = h => { const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec((h||"").trim()); return m? [parseInt(m[1],16),parseInt(m[2],16),parseInt(m[3],16)] : [230,237,243]; };
    const luminance = ([r,g,b]) => { const a=[r,g,b].map(v=>{v/=255; return (v<=0.03928)? v/12.92 : Math.pow((v+0.055)/1.055,2.4)}); return 0.2126*a[0]+0.7152*a[1]+0.0722*a[2]; };
    const contrast = (c1,c2) => { const L1=luminance(hexToRgb(c1)), L2=luminance(hexToRgb(c2)); const [hi,lo]=L1>L2?[L1,L2]:[L2,L1]; return (hi+0.05)/(lo+0.05); };

    function updateDigitContrastHints(){
      const bg = currentPreviewBgColor();
      const set = (id, val) => { const el=$(id); if(!el) return; const ratio=contrast(val,bg); el.textContent = `kontrast ${ratio.toFixed(2)}${ratio>=3?' ✔':' ⚠'}`; el.style.color = ratio>=3 ? '#69db7c' : '#ffd166'; };
      set("#c_contrast_normal", $("#color_normal").value);
      set("#c_contrast_warn",   $("#color_warn").value);
      set("#c_contrast_alert",  $("#color_alert").value);
      set("#c_contrast_over",   $("#color_over").value);
    }
    function updateMessageContrastHints(){
      const bg = currentPreviewBgColor();
      const set = (id, val) => { const el=$(id); const ratio=contrast(val,bg); el.textContent = `${ratio.toFixed(2)}${ratio>=3?' ✔':' ⚠'}`; el.style.color = ratio>=3 ? '#69db7c' : '#ffd166'; };
      set("#m_contrast_p", $("#theme_p_color").value);
      set("#m_contrast_s", $("#theme_s_color").value);
    }

    async function fetchDefaults(){ if (defaultsCache) return defaultsCache; const r=await fetch("/api/defaults"); const js=await r.json(); defaultsCache=js.defaults; return defaultsCache; }

    // Apply config -> UI
    function apply(cfg, tick){
      lastCfg=cfg;
      // modus
      const r=$(`input[name=mode][value=${cfg.mode||"daily"}]`); if(r) r.checked=true;
      $("#daily_time").value=cfg.daily_time||""; $("#once_at").value=(cfg.once_at||"").replace("Z","");
      $("#active_mode").textContent=`Aktiv modus: ${cfg.mode} · Fase: ${tick?.mode||"—"} (${tick?.state||"—"})`;

      // stopp-skjerm
      const sc=cfg.screen||{}; const sr=$(`input[name=screen_type][value=${sc.type||"text"}]`); if(sr) sr.checked=true;
      $("#screen_text").value=sc.text||"Pause"; $("#screen_text_color").value=sc.text_color||"#ffffff";
      $("#screen_bg").value=sc.bg||"#000000"; $("#screen_font_vh").value=sc.font_vh??10;
      $("#screen_image_url").value=sc.image_url||""; $("#screen_image_opacity").value=sc.image_opacity??100;
      $("#screen_image_fit").value=sc.image_fit||"cover"; $("#screen_bg_img").value=sc.bg||"#000000";

      // visning/oppførsel
      $("#use_phase_colors").checked=!!cfg.use_phase_colors; $("#use_blink").checked=!!cfg.use_blink;
      $("#color_normal").value=cfg.color_normal||"#e6edf3"; $("#color_warn").value=cfg.color_warn||"#ffd166";
      $("#color_alert").value=cfg.color_alert||"#ff6b6b"; $("#color_over").value=cfg.color_over||"#9ad0ff";
      $("#show_target_time").checked=!!cfg.show_target_time; $("#target_time_after").value=cfg.target_time_after||"secondary";
      $("#messages_position").value=cfg.messages_position||"below";
      $("#hms_threshold_minutes").value=cfg.hms_threshold_minutes??60;

      // theme – meldinger
      const p=cfg?.theme?.messages?.primary||{}, s=cfg?.theme?.messages?.secondary||{};
      $("#theme_p_size").value=String(p.size_rem??1.0); $("#theme_p_weight").value=String(p.weight??600); $("#theme_p_color").value=String(p.color??"#9aa4b2");
      $("#theme_s_size").value=String(s.size_rem??1.0); $("#theme_s_weight").value=String(s.weight??400); $("#theme_s_color").value=String(s.color??"#9aa4b2");

      // theme – digits
      $("#digits_size_preset").value=String(cfg?.theme?.digits?.size_vw??14);

      // theme – background
      const bg=cfg?.theme?.background||{}; const bm=$(`input[name=bg_mode][value=${(bg.mode||"solid")}]`); if(bm) bm.checked=true;
      $("#bg_solid_color").value = bg.solid?.color || "#0b0f14";
      $("#bg_grad_from").value   = bg.gradient?.from || "#142033";
      $("#bg_grad_to").value     = bg.gradient?.to   || "#0b0f14";
      $("#bg_grad_angle").value  = bg.gradient?.angle_deg ?? 180;
      $("#bg_img_url").value     = bg.image?.url  || "";
      $("#bg_img_fit").value     = bg.image?.fit  || "cover";
      $("#bg_img_op").value      = bg.image?.opacity ?? 1;
      $("#bg_img_tint").value    = bg.image?.tint?.color || "#000000";
      $("#bg_img_tint_op").value = bg.image?.tint?.opacity ?? 0;

      lock(); renderPreview(); updateDigitContrastHints(); updateMessageContrastHints();
    }

    async function loadAll(){ const r=await fetch("/api/config"); const js=await r.json(); js.config.tick=js.tick; apply(js.config,js.tick); pulse(hint); hint.textContent="Status oppdatert"; setTimeout(()=>hint.textContent="",1200); }

    async function saveAll(){
      const m=selMode();
      const body={
        mode:m,
        daily_time:$("#daily_time").value, once_at:$("#once_at").value,
        // visning/oppførsel
        use_phase_colors:$("#use_phase_colors").checked, use_blink:$("#use_blink").checked,
        color_normal:$("#color_normal").value, color_warn:$("#color_warn").value, color_alert:$("#color_alert").value, color_over:$("#color_over").value,
        show_target_time:$("#show_target_time").checked, target_time_after:$("#target_time_after").value,
        messages_position:$("#messages_position").value, hms_threshold_minutes:parseInt($("#hms_threshold_minutes").value||"60",10),
        // screen
        screen: undefined,
        // theme
        theme: {
          digits: { size_vw: Number($("#digits_size_preset").value||"14") },
          messages: {
            primary:   { size_rem: Number($("#theme_p_size").value||"1.0"), weight: Number($("#theme_p_weight").value||"600"), color: $("#theme_p_color").value },
            secondary: { size_rem: Number($("#theme_s_size").value||"1.0"), weight: Number($("#theme_s_weight").value||"400"), color: $("#theme_s_color").value }
          },
          background: {
            mode: selBgMode(),
            solid:    { color: $("#bg_solid_color").value },
            gradient: { from: $("#bg_grad_from").value, to: $("#bg_grad_to").value, angle_deg: Number($("#bg_grad_angle").value||"180") },
            image:    { url: $("#bg_img_url").value, fit: $("#bg_img_fit").value, opacity: Number($("#bg_img_op").value||"1"), tint: { color: $("#bg_img_tint").value, opacity: Number($("#bg_img_tint_op").value||"0") } }
          }
        }
      };
      if(m==="screen"){
        const st=$("input[name=screen_type]:checked")?.value || "text";
        body.screen={
          type:st, text:$("#screen_text").value, text_color:$("#screen_text_color").value,
          bg:(st==="image")?$("#screen_bg_img").value:$("#screen_bg").value,
          font_vh:parseInt($("#screen_font_vh").value||"10",10),
          image_url:$("#screen_image_url").value,
          image_opacity:parseInt($("#screen_image_opacity").value||"100",10),
          image_fit:$("#screen_image_fit").value
        };
      } else {
        delete body.screen;
      }
      const r=await fetch("/api/config",{method:"POST",headers:headers(),body:JSON.stringify(body)});
      if(!r.ok) throw new Error(await r.text());
      const js=await r.json(); apply(js.config, js.tick); pulse(hint); hint.textContent="Lagret"; setTimeout(()=>hint.textContent="",1200);
    }

    async function resetView(){
      const d=await fetchDefaults();
      // visning/oppførsel
      $("#use_phase_colors").checked=!!d.use_phase_colors; $("#use_blink").checked=!!d.use_blink;
      $("#color_normal").value=d.color_normal; $("#color_warn").value=d.color_warn; $("#color_alert").value=d.color_alert; $("#color_over").value=d.color_over;
      $("#show_target_time").checked=!!d.show_target_time; $("#target_time_after").value=d.target_time_after; $("#messages_position").value=d.messages_position; $("#hms_threshold_minutes").value=d.hms_threshold_minutes;
      // theme – meldinger/digits
      $("#digits_size_preset").value=String(d.theme?.digits?.size_vw??14);
      $("#theme_p_size").value=String(d.theme?.messages?.primary?.size_rem??1.0); $("#theme_p_weight").value=String(d.theme?.messages?.primary?.weight??600); $("#theme_p_color").value=d.theme?.messages?.primary?.color||"#9aa4b2";
      $("#theme_s_size").value=String(d.theme?.messages?.secondary?.size_rem??1.0); $("#theme_s_weight").value=String(d.theme?.messages?.secondary?.weight??400); $("#theme_s_color").value=d.theme?.messages?.secondary?.color||"#9aa4b2";
      // theme – background
      const bg=d.theme?.background||{};
      ($(`input[name=bg_mode][value=${bg.mode||"solid"}]`)||{}).checked=true;
      $("#bg_solid_color").value=bg.solid?.color||"#0b0f14";
      $("#bg_grad_from").value=bg.gradient?.from||"#142033";
      $("#bg_grad_to").value=bg.gradient?.to||"#0b0f14";
      $("#bg_grad_angle").value=bg.gradient?.angle_deg??180;
      $("#bg_img_url").value=bg.image?.url||"";
      $("#bg_img_fit").value=bg.image?.fit||"cover";
      $("#bg_img_op").value=bg.image?.opacity??1;
      $("#bg_img_tint").value=bg.image?.tint?.color||"#000000";
      $("#bg_img_tint_op").value=bg.image?.tint?.opacity??0;

      lock(); renderPreview(); updateDigitContrastHints(); updateMessageContrastHints();
      hint.textContent="Tilbakestilt (lagre for å aktivere)"; setTimeout(()=>hint.textContent="",1500);
    }

    // Forhåndsvisning
    function currentPreviewBgColor(){
      // grovt estimat for kontrast (bruk solid/gradient start/tint)
      const bg=selBgMode();
      if(bg==="solid") return $("#bg_solid_color").value;
      if(bg==="gradient") return $("#bg_grad_to").value;
      return $("#bg_img_tint").value; // hvis tint=0, er dette best effort
    }
    function applyPreviewBackground(){
      const box=$("#pv_box");
      const mode=selBgMode();
      if(mode==="solid"){
        box.style.background = $("#bg_solid_color").value;
      } else if(mode==="gradient"){
        box.style.background = `linear-gradient(${Number($("#bg_grad_angle").value||"180")}deg, ${$("#bg_grad_from").value}, ${$("#bg_grad_to").value})`;
      } else {
        const url=$("#bg_img_url").value||"";
        const fit=$("#bg_img_fit").value||"cover";
        const op = Number($("#bg_img_op").value||"1");
        const tintC = $("#bg_img_tint").value||"#000000";
        const tintOp= Number($("#bg_img_tint_op").value||"0");
        box.style.background = (tintOp>0)
          ? `linear-gradient(${hexToRgba(tintC,tintOp)}, ${hexToRgba(tintC,tintOp)}), url('${url}')`
          : `url('${url}')`;
        box.style.backgroundSize=fit; box.style.backgroundPosition="center"; box.style.backgroundRepeat="no-repeat";
        box.style.opacity=String(op);
      }
    }
    function hexToRgba(h, a){ const m=hexToRgb(h); return `rgba(${m.join(",")}, ${a})`; }
    function renderPreview(){
      applyPreviewBackground(); updateDigitContrastHints(); updateMessageContrastHints();
      const vw=Number($("#digits_size_preset").value||"14");
      $("#pv_digits").style.fontSize = `clamp(4vw, ${vw*0.55}vw, ${vw*0.8}vw)`; // mindre og proporsjonal
      const p={ size_rem:Number($("#theme_p_size").value||"1.0"), weight:Number($("#theme_p_weight").value||"600"), color:$("#theme_p_color").value };
      const s={ size_rem:Number($("#theme_s_size").value||"1.0"), weight:Number($("#theme_s_weight").value||"400"), color:$("#theme_s_color").value };
      [["#pv_prim_above","#pv_prim_below"]].flat().forEach(sel=>{ const el=$(sel); el.style.fontSize=`${p.size_rem}rem`; el.style.fontWeight=String(p.weight); el.style.color=p.color; });
      [["#pv_sec_above","#pv_sec_below"]].flat().forEach(sel=>{ const el=$(sel); el.style.fontSize=`${s.size_rem}rem`; el.style.fontWeight=String(s.weight); el.style.color=s.color; });

      const showAbove = ($("#messages_position").value||"below")==="above";
      $("#pv_above").style.display = showAbove?"block":"none";
      $("#pv_below").style.display  = showAbove?"none":"block";

      // Digitfarge basert på simulering
      const sim = ($$("input[name=pv_state]:checked")[0]?.value)||"normal";
      let color = $("#color_normal").value;
      if($("#use_phase_colors").checked){
        if(sim==="overrun") color=$("#color_over").value;
        else if(sim==="alert") color=$("#color_alert").value;
        else if(sim==="warn")  color=$("#color_warn").value;
      }
      const digits=$("#pv_digits");
      digits.style.color = color;
      digits.classList.toggle("blink", $("#pv_blink").checked && $("#use_blink").checked);
    }

    // synk-pill
    async function updateSyncPill(){
      try{
        const r=await fetch("/debug/view-heartbeat"); const js=await r.json();
        const hb=js.heartbeat||{}; const age=hb.age_seconds??9999;
        const viewRev=hb.rev||0; const cfgRev=(lastCfg&&lastCfg._updated_at)?lastCfg._updated_at:0;
        if(age>30||!hb.ts_iso){ pill.textContent="Synk: visning offline"; pill.className="pill off"; }
        else if(viewRev>=cfgRev){ pill.textContent=`Synk: OK (rev ${viewRev})`; pill.className="pill ok"; }
        else { pill.textContent=`Synk: venter (view ${viewRev} < cfg ${cfgRev})`; pill.className="pill warn"; }
      }catch(e){ pill.textContent="Synk: —"; pill.className="pill off"; }
    }

    // events
    $$("input[name=mode]").forEach(el=>el.addEventListener("change",()=>{lock(); renderPreview();}));
    $$("input[name=screen_type]").forEach(el=>el.addEventListener("change",lock));
    $$(".preset").forEach(b=>b.addEventListener("click",()=>{$("#start_minutes").value=b.dataset.min;}));
    ["use_phase_colors","use_blink","color_normal","color_warn","color_alert","color_over","messages_position","hms_threshold_minutes"].forEach(id=>{
      $("#"+id).addEventListener("input", ()=>{ renderPreview(); updateDigitContrastHints(); });
    });
    ["theme_p_size","theme_p_weight","theme_p_color","theme_s_size","theme_s_weight","theme_s_color","digits_size_preset"].forEach(id=>{
      $("#"+id).addEventListener("input", ()=>{ renderPreview(); updateMessageContrastHints(); });
    });
    $$("input[name=bg_mode]").forEach(el=>el.addEventListener("change", ()=>{lock(); renderPreview();}));
    ["bg_solid_color","bg_grad_from","bg_grad_to","bg_grad_angle","bg_img_url","bg_img_fit","bg_img_op","bg_img_tint","bg_img_tint_op"].forEach(id=>{
      $("#"+id).addEventListener("input", renderPreview);
    });
    $$("input[name=pv_state]").forEach(el=>el.addEventListener("change", renderPreview));
    $("#pv_blink").addEventListener("change", renderPreview);

    $("#btn_save").addEventListener("click",()=>saveAll().catch(e=>alert(e.message)));
    $("#btn_refresh").addEventListener("click",()=>loadAll().catch(e=>alert(e.message)));
    $("#btn_reset_view").addEventListener("click",()=>resetView().catch(e=>alert(e.message)));

    // init
    loadAll().catch(console.error);
    setInterval(updateSyncPill, 3000);
  })();
  </script>
</body>
</html>
