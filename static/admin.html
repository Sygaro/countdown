<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Countdown · Admin</title>
  <link rel="stylesheet" href="/static/css/ui.css"/>
  <style>
    .actions { position: sticky; top: 0; z-index: 5; padding: 10px 16px; background: rgba(11,15,20,.85); backdrop-filter: blur(8px); border-bottom:1px solid var(--border); display:flex; gap:8px; align-items:center }
    .pill { padding:4px 8px; border-radius:999px; font-size:.85rem; border:1px solid var(--border); }
    .ok { color:#0b0f14; background:#69db7c; border-color:transparent; }
    .warn { color:#0b0f14; background:#ffd166; border-color:transparent; }
    .off { color:#e6edf3; background:#374151; }
    .row { display:flex; flex-wrap:wrap; gap:10px; align-items:center }
    .hint-inline { font-size:.85rem; opacity:.9; margin-left:6px }
    .preview { background:#0b0f14;border:1px solid var(--border); border-radius:12px; padding:14px; min-height:200px; display:flex; align-items:center; justify-content:center }
    .pv-box { width:100%; max-width:800px; aspect-ratio: 16/8; border:1px solid var(--border); border-radius:10px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; padding:10px; }
    .pv-digits { font-weight:800; letter-spacing:.06em; font-size: clamp(4vw, 8vw, 10vw); }
    .tag { font-size:.8rem; color:var(--muted); border:1px dashed var(--border); padding:2px 6px; border-radius:6px }
  </style>
</head>
<body>
  <header>
    <h1>Countdown · Admin</h1>
    <nav>
      <a href="/">Visning</a>
      <a class="active" href="/admin">Admin</a>
      <a href="/diag">Diagnose</a>
      <a href="/about">Om</a>
    </nav>
  </header>

  <div class="actions">
    <button id="btn_save" class="primary">Lagre</button>
    <button id="btn_refresh">Oppdater</button>
    <button id="btn_reset_view">Tilbakestill visning</button>
    <span id="sync_pill" class="pill off">Synk: —</span>
    <span id="save_hint" class="muted"></span>
  </div>

  <main class="grid">
    <!-- Modus -->
    <section class="card">
      <h2>Modus</h2>
      <label><input type="radio" name="mode" value="daily"/> Daglig klokkeslett</label>
      <input id="daily_time" type="time" step="60"/>
      <br/>
      <label><input type="radio" name="mode" value="once"/> Engangs-tidspunkt</label>
      <input id="once_at" type="datetime-local"/>
      <br/>
      <label><input type="radio" name="mode" value="duration"/> Varighet (manuell start)</label>
      <br/>
      <label><input type="radio" name="mode" value="clock"/> Klokke</label>
      <p class="hint">Velg én modus. Lagre for at endring skal gjelde.</p>
      <p id="active_mode" class="muted">Aktiv modus: —</p>
    </section>

    <!-- Start med varighet -->
    <section class="card">
      <h2>Start med varighet</h2>
      <div class="row">
        <button class="preset" data-min="5">+5 min</button>
        <button class="preset" data-min="10">+10 min</button>
        <button class="preset" data-min="15">+15 min</button>
        <button class="preset" data-min="30">+30 min</button>
        <label>Varighet (minutter) <input id="start_minutes" type="number" min="1" step="1" value="10"/></label>
        <button id="btn_start" class="primary">Start nedtelling nå</button>
        <button id="btn_stop">Stopp</button>
      </div>
      <p class="hint">Starter alltid varighetsmodus umiddelbart.</p>
    </section>

    <!-- Meldinger (innhold) -->
    <section class="card">
      <h2>Meldinger</h2>
      <label><input id="show_message_primary" type="checkbox"/> Vis hovedmelding</label>
      <textarea id="message_primary" rows="2" placeholder="Velkommen !"></textarea>
      <label><input id="show_message_secondary" type="checkbox"/> Vis sekundær melding</label>
      <input id="message_secondary" type="text" placeholder="Vi starter igjen kl:"/>
    </section>

    <!-- Varsler / blink -->
    <section class="card">
      <h2>Varsler / blink</h2>
      <div class="row">
        <label>Gult ved (min igjen) <input id="warn_minutes" type="number" min="0" step="1"/></label>
        <label>Rødt ved (min igjen) <input id="alert_minutes" type="number" min="0" step="1"/></label>
        <label>Blink de siste (sek) <input id="blink_seconds" type="number" min="0" step="1"/></label>
        <label>Vis minus-tid (min etterpå) <input id="overrun_minutes" type="number" min="0" step="1"/></label>
      </div>
    </section>

    <!-- Visning / oppførsel -->
    <section class="card">
      <h2>Visning / oppførsel</h2>
      <div class="help">Terskel: ved ≥ verdi vises <strong>H:MM:SS</strong>, ellers <strong>MM:SS</strong> (70→2:00:00, 300→120:00).</div>
      <label><input id="use_phase_colors" type="checkbox"/> Fargelegg ved gult/rødt</label>
      <label><input id="use_blink" type="checkbox"/> Blink de siste sekundene</label>

      <div class="row">
        <label>Farge normal <input id="color_normal" type="color" value="#e6edf3"/></label><span id="c_contrast_normal" class="hint-inline"></span>
      </div>
      <div class="row">
        <label>Farge gul <input id="color_warn" type="color" value="#ffd166"/></label><span id="c_contrast_warn" class="hint-inline"></span>
      </div>
      <div class="row">
        <label>Farge rød <input id="color_alert" type="color" value="#ff6b6b"/></label><span id="c_contrast_alert" class="hint-inline"></span>
      </div>
      <div class="row">
        <label>Farge minus-tid <input id="color_over" type="color" value="#9ad0ff"/></label><span id="c_contrast_over" class="hint-inline"></span>
      </div>

      <label><input id="show_target_time" type="checkbox"/> Vis mål-klokkeslett</label>
      <label>Plassering av mål-klokkeslett
        <select id="target_time_after"><option value="primary">etter hovedmelding</option><option value="secondary">etter sekundær melding</option></select>
      </label>
      <label>Plassering av meldinger
        <select id="messages_position"><option value="above">over nedtellingen</option><option value="below">under nedtellingen</option></select>
      </label>
      <label>Tidsformat → H:MM:SS når over (min)
        <input id="hms_threshold_minutes" type="number" min="0" max="720" step="1" value="60"/>
      </label>
    </section>

    <!-- Utseende – Meldinger -->
    <section class="card">
      <h2>Utseende – Meldinger</h2>
      <div class="row">
        <strong>Hovedmelding</strong>
        <label>Størrelse (rem) <input id="theme_p_size" type="number" step="0.1" min="0.6" max="3.0"/></label>
        <label>Vekt
          <select id="theme_p_weight"><option>300</option><option>400</option><option>500</option><option selected>600</option><option>700</option><option>800</option><option>900</option></select>
        </label>
        <label>Farge <input id="theme_p_color" type="color"/></label>
        <span id="m_contrast_p" class="hint-inline tag"></span>
      </div>
      <div class="row">
        <strong>Sekundær</strong>
        <label>Størrelse (rem) <input id="theme_s_size" type="number" step="0.1" min="0.6" max="3.0"/></label>
        <label>Vekt
          <select id="theme_s_weight"><option>300</option><option selected>400</option><option>500</option><option>600</option><option>700</option><option>800</option><option>900</option></select>
        </label>
        <label>Farge <input id="theme_s_color" type="color"/></label>
        <span id="m_contrast_s" class="hint-inline tag"></span>
      </div>
      <div class="row">
        <strong>Digits</strong>
        <label>Størrelse
          <select id="digits_size_preset">
            <option value="14">Normal</option><option value="18">Stor</option><option value="22">Ekstra stor</option>
          </select>
        </label>
      </div>
    </section>

    <!-- Utseende – Bakgrunn (visningen) -->
    <section class="card">
      <h2>Utseende – Bakgrunn</h2>
      <div class="row">
        <label>Preset
          <select id="bg_preset">
            <option value="none">(ingen)</option>
            <option value="dark-solid">Mørk ensfarget</option>
            <option value="dark-grad">Mørk gradient</option>
            <option value="photo-tint">Foto m/tint</option>
          </select>
        </label>
        <button id="btn_apply_preset">Bruk preset</button>
      </div>
      <label><input type="radio" name="bg_mode" value="solid"/> Ensfarget</label>
      <label><input type="radio" name="bg_mode" value="gradient"/> Gradient</label>
      <label><input type="radio" name="bg_mode" value="image"/> Bilde</label>

      <div id="bg_solid_cfg">
        <label>Farge <input id="bg_solid_color" type="color" value="#0b0f14"/></label>
      </div>
      <div id="bg_grad_cfg">
        <label>Fra <input id="bg_grad_from" type="color" value="#142033"/></label>
        <label>Til <input id="bg_grad_to" type="color" value="#0b0f14"/></label>
        <label>Vinkel (°) <input id="bg_grad_angle" type="number" min="0" max="360" step="1" value="180"/></label>
      </div>
      <div id="bg_img_cfg">
        <label>Bilde-URL <input id="bg_img_url" type="url" placeholder="https://..."/></label>
        <label>Fit
          <select id="bg_img_fit"><option>cover</option><option>contain</option></select>
        </label>
        <label>Opacity (0–1) <input id="bg_img_op" type="number" min="0" max="1" step="0.05" value="1"/></label>
        <label>Tint-farge <input id="bg_img_tint" type="color" value="#000000"/></label>
        <label>Tint-opacity (0–1) <input id="bg_img_tint_op" type="number" min="0" max="1" step="0.05" value="0"/></label>
      </div>
    </section>

    <section class="card">
  <h2>Klokke</h2>
  <div class="row">
    <label><input id="clk_with_seconds" type="checkbox"> Vis sekunder</label>
    <label>Farge <input id="clk_color" type="color" value="#e6edf3"></label>
    <label>Størrelse (vmin) <input id="clk_size_vmin" type="number" min="6" max="30" step="1" value="12"></label>
    <label>Plassering
      <select id="clk_position">
        <option value="center">Midtstilt</option>
        <option value="top-left">Øvre venstre</option>
        <option value="top-right">Øvre høyre</option>
        <option value="bottom-left">Nedre venstre</option>
        <option value="bottom-right">Nedre høyre</option>
      </select>
    </label>
  </div>
  <p class="hint">Klokken bruker temaets bakgrunn (Theme → Background). <code>vmin</code> gir konsistent størrelse i både stående og liggende format.</p>
</section>

 

  </main>

 <script>
  (function(){
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const pill = $("#sync_pill"), hint = $("#save_hint");
    let lastCfg = null, defaultsCache = null;

    // -------- helpers --------
    const val = (sel, def = "") => (document.querySelector(sel)?.value ?? def);
    const checked = (sel) => !!document.querySelector(sel)?.checked;
    const num = (sel, def = 0) => { const v = parseFloat(val(sel, "")); return Number.isFinite(v) ? v : def; };

    async function fetchDefaults(){
      if (defaultsCache) return defaultsCache;
      const r = await fetch("/api/defaults");
      const js = await r.json();
      defaultsCache = js.defaults;
      return defaultsCache;
    }
    function headers(){
      const pwd = ($("#admin_password")?.value || "").trim();
      const h = {"Content-Type":"application/json"};
      if (pwd) h["X-Admin-Password"] = pwd;
      return h;
    }
    const selMode   = () => ($$("input[name=mode]:checked")[0]?.value) || "daily";
    const selBgMode = () => ($$("input[name=bg_mode]:checked")[0]?.value) || "solid";

    function lock(){
      const m = selMode();
      const bg = selBgMode();

      // Modus-avhengig
      const daily = $("#daily_time"), onceAt = $("#once_at");
      if (daily) daily.disabled = (m !== "daily");
      if (onceAt) onceAt.disabled = (m !== "once");

      // Bakgrunn (visning)
      $("#bg_solid_cfg") && ($("#bg_solid_cfg").style.display = bg === "solid"    ? "block" : "none");
      $("#bg_grad_cfg")  && ($("#bg_grad_cfg").style.display  = bg === "gradient" ? "block" : "none");
      $("#bg_img_cfg")   && ($("#bg_img_cfg").style.display   = bg === "image"    ? "block" : "none");

      // Klokke-felter er valgfrie – hvis de finnes, deaktiver utenom clock-modus
      const isClock = m === "clock";
      $("#clk_with_seconds") && ($("#clk_with_seconds").disabled = !isClock);
      $("#clk_color")        && ($("#clk_color").disabled        = !isClock);
      $("#clk_size_vmin")    && ($("#clk_size_vmin").disabled    = !isClock);
      $("#clk_position")     && ($("#clk_position").disabled     = !isClock);


    // -------- kontrast-hint (som før) --------
    const hexToRgb = h => { const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec((h||"").trim()); return m? [parseInt(m[1],16),parseInt(m[2],16),parseInt(m[3],16)] : [230,237,243]; };
    const luminance = ([r,g,b]) => { const a=[r,g,b].map(v=>{v/=255; return (v<=0.03928)? v/12.92 : Math.pow((v+0.055)/1.055,2.4)}); return 0.2126*a[0]+0.7152*a[1]+0.0722*a[2]; };
    const contrast = (c1,c2) => { const L1=luminance(hexToRgb(c1)), L2=luminance(hexToRgb(c2)); const [hi,lo]=L1>L2?[L1,L2]:[L2,L1]; return (hi+0.05)/(lo+0.05); };
    function currentPreviewBgColor(){
      const bg = selBgMode();
      if (bg === "solid")    return val("#bg_solid_color","#0b0f14");
      if (bg === "gradient") return val("#bg_grad_to","#0b0f14");
      return val("#bg_img_tint","#000000");
    }
    function updateDigitContrastHints(){
      const bg = currentPreviewBgColor();
      const set=(id, color)=>{ const el=$(id); if(!el) return; const ratio=contrast(color,bg); el.textContent=`kontrast ${ratio.toFixed(2)}${ratio>=3?' ✔':' ⚠'}`; el.style.color=ratio>=3?'#69db7c':'#ffd166'; };
      set("#c_contrast_normal", val("#color_normal","#e6edf3"));
      set("#c_contrast_warn",   val("#color_warn","#ffd166"));
      set("#c_contrast_alert",  val("#color_alert","#ff6b6b"));
      set("#c_contrast_over",   val("#color_over","#9ad0ff"));
    }
    function updateMessageContrastHints(){
      const bg = currentPreviewBgColor();
      const set=(id, color)=>{ const el=$(id); if(!el) return; const ratio=contrast(color,bg); el.textContent=`${ratio.toFixed(2)}${ratio>=3?' ✔':' ⚠'}`; el.style.color=ratio>=3?'#69db7c':'#ffd166'; };
      $("#m_contrast_p") && set("#m_contrast_p", val("#theme_p_color","#9aa4b2"));
      $("#m_contrast_s") && set("#m_contrast_s", val("#theme_s_color","#9aa4b2"));
    }

    // -------- apply() --------
    function apply(cfg, tick){
      lastCfg = cfg;

      // Modus + info
      ( $(`input[name=mode][value=${cfg.mode||"daily"}]`) || {} ).checked = true;
      $("#daily_time") && ($("#daily_time").value = cfg.daily_time || "");
      $("#once_at")    && ($("#once_at").value    = (cfg.once_at || "").replace("Z",""));
      $("#active_mode") && ($("#active_mode").textContent = `Aktiv modus: ${cfg.mode} · Fase: ${tick?.mode||"—"} (${tick?.state||"—"})`);

      // Meldinger
      $("#show_message_primary") && ($("#show_message_primary").checked = !!cfg.show_message_primary);
      $("#show_message_secondary") && ($("#show_message_secondary").checked = !!cfg.show_message_secondary);
      $("#message_primary") && ($("#message_primary").value = cfg.message_primary || "");
      $("#message_secondary") && ($("#message_secondary").value = cfg.message_secondary || "");

      // Varsler/blink
      $("#warn_minutes")    && ($("#warn_minutes").value    = cfg.warn_minutes    ?? 4);
      $("#alert_minutes")   && ($("#alert_minutes").value   = cfg.alert_minutes   ?? 2);
      $("#blink_seconds")   && ($("#blink_seconds").value   = cfg.blink_seconds   ?? 10);
      $("#overrun_minutes") && ($("#overrun_minutes").value = cfg.overrun_minutes ?? 1);

      // Visning/oppførsel
      $("#use_phase_colors")   && ($("#use_phase_colors").checked = !!cfg.use_phase_colors);
      $("#use_blink")          && ($("#use_blink").checked        = !!cfg.use_blink);
      $("#color_normal")       && ($("#color_normal").value       = cfg.color_normal || "#e6edf3");
      $("#color_warn")         && ($("#color_warn").value         = cfg.color_warn   || "#ffd166");
      $("#color_alert")        && ($("#color_alert").value        = cfg.color_alert  || "#ff6b6b");
      $("#color_over")         && ($("#color_over").value         = cfg.color_over   || "#9ad0ff");
      $("#show_target_time")   && ($("#show_target_time").checked = !!cfg.show_target_time);
      $("#target_time_after")  && ($("#target_time_after").value  = cfg.target_time_after || "secondary");
      $("#messages_position")  && ($("#messages_position").value  = cfg.messages_position || "below");
      $("#hms_threshold_minutes") && ($("#hms_threshold_minutes").value = cfg.hms_threshold_minutes ?? 60);

      // Theme
      const p = cfg?.theme?.messages?.primary   || {};
      const s = cfg?.theme?.messages?.secondary || {};
      $("#theme_p_size")   && ($("#theme_p_size").value   = String(p.size_rem ?? 1.0));
      $("#theme_p_weight") && ($("#theme_p_weight").value = String(p.weight   ?? 600));
      $("#theme_p_color")  && ($("#theme_p_color").value  = String(p.color    ?? "#9aa4b2"));
      $("#theme_s_size")   && ($("#theme_s_size").value   = String(s.size_rem ?? 1.0));
      $("#theme_s_weight") && ($("#theme_s_weight").value = String(s.weight   ?? 400));
      $("#theme_s_color")  && ($("#theme_s_color").value  = String(s.color    ?? "#9aa4b2"));
      $("#digits_size_preset") && ($("#digits_size_preset").value = String(cfg?.theme?.digits?.size_vw ?? 14));

      // Bakgrunn (visningen)
      const bg = cfg?.theme?.background || {};
      ( $(`input[name=bg_mode][value=${(bg.mode||"solid")}]`) || {} ).checked = true;
      $("#bg_solid_color") && ($("#bg_solid_color").value = bg.solid?.color || "#0b0f14");
      $("#bg_grad_from")   && ($("#bg_grad_from").value   = bg.gradient?.from || "#142033");
      $("#bg_grad_to")     && ($("#bg_grad_to").value     = bg.gradient?.to   || "#0b0f14");
      $("#bg_grad_angle")  && ($("#bg_grad_angle").value  = bg.gradient?.angle_deg ?? 180);
      $("#bg_img_url")     && ($("#bg_img_url").value     = bg.image?.url  || "");
      $("#bg_img_fit")     && ($("#bg_img_fit").value     = bg.image?.fit  || "cover");
      $("#bg_img_op")      && ($("#bg_img_op").value      = bg.image?.opacity ?? 1);
      $("#bg_img_tint")    && ($("#bg_img_tint").value    = bg.image?.tint?.color || "#000000");
      $("#bg_img_tint_op") && ($("#bg_img_tint_op").value = bg.image?.tint?.opacity ?? 0);

      // Ny: klokke (top-level) – hvis feltene finnes
      const clk = cfg?.clock || {};
      $("#clk_with_seconds") && ($("#clk_with_seconds").checked = !!clk.with_seconds);
      $("#clk_color")        && ($("#clk_color").value = clk.color || "#e6edf3");
      $("#clk_size_vmin")    && ($("#clk_size_vmin").value = clk.size_vmin ?? 12);
      $("#clk_position")     && ($("#clk_position").value = clk.position || "center");

      lock();
      updateDigitContrastHints();
      updateMessageContrastHints();
    }

    // -------- I/O --------
    async function loadAll(){
      const r = await fetch("/api/config");
      const js = await r.json();
      js.config.tick = js.tick;
      apply(js.config, js.tick);
      hint && (hint.textContent = "Status oppdatert");
      setTimeout(()=>{ if(hint) hint.textContent = ""; }, 1200);
    }

    async function saveAll(){
      const m = selMode();

      // Bygg clock-del, men bare hvis feltene finnes – ellers bruk lastCfg.clock som fallback
      const clock = (function(){
        if ($("#clk_with_seconds") || $("#clk_color") || $("#clk_size_vh")) {
          return {
            with_seconds: checked("#clk_with_seconds"),
            color: val("#clk_color","#e6edf3"),
            size_vh: Number(val("#clk_size_vh","12"))
          };
        }
        return lastCfg?.clock || {};
      })();

      const body = {
        mode: m,
        daily_time: val("#daily_time"),
        once_at:    val("#once_at"),

        // meldinger
        show_message_primary:   checked("#show_message_primary"),
        show_message_secondary: checked("#show_message_secondary"),
        message_primary:   val("#message_primary"),
        message_secondary: val("#message_secondary"),

        // varsler/blink
        warn_minutes:   num("#warn_minutes",4),
        alert_minutes:  num("#alert_minutes",2),
        blink_seconds:  num("#blink_seconds",10),
        overrun_minutes:num("#overrun_minutes",1),

        // visning/oppførsel
        use_phase_colors: checked("#use_phase_colors"),
        use_blink:        checked("#use_blink"),
        color_normal: val("#color_normal","#e6edf3"),
        color_warn:   val("#color_warn","#ffd166"),
        color_alert:  val("#color_alert","#ff6b6b"),
        color_over:   val("#color_over","#9ad0ff"),
        show_target_time: checked("#show_target_time"),
        target_time_after: val("#target_time_after","secondary"),
        messages_position: val("#messages_position","below"),
        hms_threshold_minutes: parseInt(val("#hms_threshold_minutes","60"),10),

        // theme (digits/messages/bg)
        theme: {
          digits: { size_vw: Number(val("#digits_size_preset","14")) },
          messages: {
            primary:   { size_rem: Number(val("#theme_p_size","1.0")), weight: Number(val("#theme_p_weight","600")), color: val("#theme_p_color","#9aa4b2") },
            secondary: { size_rem: Number(val("#theme_s_size","1.0")), weight: Number(val("#theme_s_weight","400")), color: val("#theme_s_color","#9aa4b2") }
          },
          background: {
            mode: selBgMode(),
            solid:    { color: val("#bg_solid_color","#0b0f14") },
            gradient: { from: val("#bg_grad_from","#142033"), to: val("#bg_grad_to","#0b0f14"), angle_deg: Number(val("#bg_grad_angle","180")) },
            image:    { url: val("#bg_img_url",""), fit: val("#bg_img_fit","cover"), opacity: Number(val("#bg_img_op","1")), tint: { color: val("#bg_img_tint","#000000"), opacity: Number(val("#bg_img_tint_op","0")) } }
          }
        },

        // ny topp-nøkkel
        clock: {
          with_seconds: checked("#clk_with_seconds"),
          color:        val("#clk_color","#e6edf3"),
          size_vmin:    Number(val("#clk_size_vmin","12")),
          position:     val("#clk_position","center")
        }
      };

      const r = await fetch("/api/config", { method:"POST", headers:headers(), body: JSON.stringify(body) });
      if (!r.ok) throw new Error(await r.text());
      const js = await r.json();
      apply(js.config, js.tick);
      hint && (hint.textContent = "Lagret");
      setTimeout(()=>{ if(hint) hint.textContent=""; }, 1200);
    }

    // -------- start/stopp varighet (uendret) --------
    async function startDuration(){
      const minutes = parseInt(val("#start_minutes","0"), 10);
      if (!Number.isFinite(minutes) || minutes <= 0) { alert("Ugyldig varighet"); return; }
      const r = await fetch("/api/start-duration",{method:"POST",headers:headers(),body:JSON.stringify({minutes})});
      if(!r.ok){ alert(await r.text()); return; }
      await loadAll();
    }
    async function stopDurationSwitchDaily(){
      const r = await fetch("/api/config",{method:"POST",headers:headers(),body:JSON.stringify({mode:"daily"})});
      if(!r.ok){ alert(await r.text()); return; }
      await loadAll();
    }

    // -------- presets --------
    function applyPreset(){
      const p = val("#bg_preset","none");
      if (p==="dark-solid"){
        ($(`input[name=bg_mode][value=solid]`)||{}).checked=true;
        $("#bg_solid_color") && ($("#bg_solid_color").value="#0b0f14");
      } else if (p==="dark-grad"){
        ($(`input[name=bg_mode][value=gradient]`)||{}).checked=true;
        $("#bg_grad_from") && ($("#bg_grad_from").value="#111827");
        $("#bg_grad_to") && ($("#bg_grad_to").value="#0b0f14");
        $("#bg_grad_angle") && ($("#bg_grad_angle").value=180);
      } else if (p==="photo-tint"){
        ($(`input[name=bg_mode][value=image]`)||{}).checked=true;
        $("#bg_img_url") && ($("#bg_img_url").value="https://picsum.photos/1600/900");
        $("#bg_img_fit") && ($("#bg_img_fit").value="cover");
        $("#bg_img_op") && ($("#bg_img_op").value=1);
        $("#bg_img_tint") && ($("#bg_img_tint").value="#000000");
        $("#bg_img_tint_op") && ($("#bg_img_tint_op").value=0.4);
      }
      lock(); updateDigitContrastHints(); updateMessageContrastHints();
    }

    // -------- synk-pill --------
    async function updateSyncPill(){
      try{
        const r=await fetch("/debug/view-heartbeat"); const js=await r.json();
        const hb=js.heartbeat||{}; const age=hb.age_seconds??9999;
        const viewRev=hb.rev||0; const cfgRev=(lastCfg&&lastCfg._updated_at)?lastCfg._updated_at:0;
        if (age>30 || !hb.ts_iso) { pill && (pill.textContent="Synk: visning offline"); pill && (pill.className="pill off"); }
        else if (viewRev>=cfgRev) { pill && (pill.textContent=`Synk: OK (rev ${viewRev})`); pill && (pill.className="pill ok"); }
        else { pill && (pill.textContent=`Synk: venter (view ${viewRev} < cfg ${cfgRev})`); pill && (pill.className="pill warn"); }
      } catch { pill && (pill.textContent="Synk: —"); pill && (pill.className="pill off"); }
    }

    // -------- events --------
    $$("input[name=mode]").forEach(el=>el.addEventListener("change", lock));
    $$("input[name=bg_mode]").forEach(el=>el.addEventListener("change", ()=>{ lock(); updateDigitContrastHints(); updateMessageContrastHints(); }));
    ["color_normal","color_warn","color_alert","color_over","theme_p_color","theme_s_color"].forEach(id=>{
      const e = document.getElementById(id);
      e && e.addEventListener("input", ()=>{ updateDigitContrastHints(); updateMessageContrastHints(); });
    });
    $$(".preset").forEach(b=>b.addEventListener("click", ()=>{ const e=$("#start_minutes"); if(e) e.value=b.dataset.min; }));
    $("#btn_apply_preset") && $("#btn_apply_preset").addEventListener("click", applyPreset);
    $("#btn_save") && $("#btn_save").addEventListener("click", ()=>saveAll().catch(e=>alert(e.message)));
    $("#btn_refresh") && $("#btn_refresh").addEventListener("click", ()=>loadAll().catch(e=>alert(e.message)));
    $("#btn_reset_view") && $("#btn_reset_view").addEventListener("click", ()=>fetchDefaults().then(d=>{
      const M=d.theme.messages, B=d.theme.background, D=d.theme.digits;
      $("#digits_size_preset") && ($("#digits_size_preset").value=String(D.size_vw));
      $("#theme_p_size") && ($("#theme_p_size").value=String(M.primary.size_rem));
      $("#theme_p_weight") && ($("#theme_p_weight").value=String(M.primary.weight));
      $("#theme_p_color") && ($("#theme_p_color").value=M.primary.color);
      $("#theme_s_size") && ($("#theme_s_size").value=String(M.secondary.size_rem));
      $("#theme_s_weight") && ($("#theme_s_weight").value=String(M.secondary.weight));
      $("#theme_s_color") && ($("#theme_s_color").value=M.secondary.color);
      ($(`input[name=bg_mode][value=${B.mode}]`)||{}).checked=true;
      $("#bg_solid_color") && ($("#bg_solid_color").value=B.solid.color);
      $("#bg_grad_from") && ($("#bg_grad_from").value=B.gradient.from);
      $("#bg_grad_to") && ($("#bg_grad_to").value=B.gradient.to);
      $("#bg_grad_angle") && ($("#bg_grad_angle").value=B.gradient.angle_deg);
      $("#bg_img_url") && ($("#bg_img_url").value=B.image.url);
      $("#bg_img_fit") && ($("#bg_img_fit").value=B.image.fit);
      $("#bg_img_op") && ($("#bg_img_op").value=B.image.opacity);
      $("#bg_img_tint") && ($("#bg_img_tint").value=B.image.tint.color);
      $("#bg_img_tint_op") && ($("#bg_img_tint_op").value=B.image.tint.opacity);
      lock(); updateDigitContrastHints(); updateMessageContrastHints();
    }));
    $("#btn_start") && $("#btn_start").addEventListener("click", ()=>startDuration().catch(e=>alert(e.message)));
    $("#btn_stop") && $("#btn_stop").addEventListener("click", ()=>stopDurationSwitchDaily().catch(e=>alert(e.message)));

    // -------- init --------
    loadAll().catch(console.error);
    setInterval(updateSyncPill, 3000);
  })();
</script>


</body>
</html>
