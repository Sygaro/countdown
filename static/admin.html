<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Countdown · Admin</title>
  <link rel="stylesheet" href="/static/css/ui.css"/>
  <style>
    .actions { position: sticky; top: 0; z-index: 5; padding: 10px 16px; background: rgba(11,15,20,.85); backdrop-filter: blur(8px); border-bottom:1px solid var(--border); display:flex; gap:8px; align-items:center }
    .pill { padding:4px 8px; border-radius:999px; font-size:.85rem; border:1px solid var(--border); }
    .ok { color:#0b0f14; background:#69db7c; border-color:transparent; }
    .warn { color:#0b0f14; background:#ffd166; border-color:transparent; }
    .off { color:#e6edf3; background:#374151; }
    .preview { background:#0b0f14;border:1px solid var(--border); border-radius:12px; padding:16px; min-height:220px; display:flex; align-items:center; justify-content:center }
  </style>
</head>
<body>
  <header>
    <h1>Countdown · Admin</h1>
    <nav>
      <a href="/">Visning</a>
      <a class="active" href="/admin">Admin</a>
      <a href="/diag">Diagnose</a>
      <a href="/about">Om</a>
    </nav>
  </header>

  <div class="actions">
    <button id="btn_save" class="primary" title="Lagre endringer">Lagre</button>
    <button id="btn_refresh" title="Hent status fra server">Oppdater</button>
    <button id="btn_reset_view" title="Tilbakestill (hentes fra server-defaults)">Tilbakestill visning</button>
    <span id="sync_pill" class="pill off">Synk: —</span>
    <span id="save_hint" class="muted"></span>
  </div>

  <main class="grid">
    <!-- … eksisterende seksjoner: Modus, Start, Stopp-skjerm, Visning/oppførsel, Meldinger, Varsler, Sikkerhet, Debug … -->

    <section class="card">
      <h2>Utseende – Meldinger</h2>
      <div class="help">Styr typografi for hoved- og sekundærmelding. Endringene forhåndsvises under, men lagres ikke før du trykker <em>Lagre</em>.</div>
      <div class="row">
        <strong>Hovedmelding</strong>
        <label>Størrelse (rem) <input id="theme_p_size" type="number" step="0.1" min="0.6" max="3.0"/></label>
        <label>Vekt
          <select id="theme_p_weight">
            <option>300</option><option>400</option><option>500</option>
            <option selected>600</option><option>700</option><option>800</option><option>900</option>
          </select>
        </label>
        <label>Farge <input id="theme_p_color" type="color"/></label>
      </div>
      <div class="row">
        <strong>Sekundær</strong>
        <label>Størrelse (rem) <input id="theme_s_size" type="number" step="0.1" min="0.6" max="3.0"/></label>
        <label>Vekt
          <select id="theme_s_weight">
            <option>300</option><option selected>400</option><option>500</option>
            <option>600</option><option>700</option><option>800</option><option>900</option>
          </select>
        </label>
        <label>Farge <input id="theme_s_color" type="color"/></label>
      </div>
      <div class="row">
        <strong>Digits</strong>
        <label>Størrelse
          <select id="digits_size_preset">
            <option value="14">Normal</option>
            <option value="18">Stor</option>
            <option value="22">Ekstra stor</option>
          </select>
        </label>
      </div>
    </section>

    <section class="card">
      <h2>Forhåndsvisning</h2>
      <div id="preview" class="preview">
        <div style="display:flex;flex-direction:column;align-items:center;gap:12px">
          <div id="pv_msgs_above" style="display:none;text-align:center">
            <div id="pv_prim_above"></div>
            <div id="pv_sec_above"></div>
          </div>
          <div id="pv_digits" class="big">12:34</div>
          <div id="pv_msgs_below" style="display:block;text-align:center">
            <div id="pv_prim_below"></div>
            <div id="pv_sec_below"></div>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Debug</h2>
      <pre id="debug">( tom )</pre>
    </section>
  </main>

  <script>
    (function(){
      const $ = s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
      const debug=$("#debug"), hint=$("#save_hint"), pill=$("#sync_pill");
      let lastCfg=null, defaultsCache=null;

      async function fetchDefaults(){
        if (defaultsCache) return defaultsCache;
        const r = await fetch("/api/defaults"); const js = await r.json();
        defaultsCache = js.defaults; return defaultsCache;
      }

      function headers(){
        const pwd = ($("#admin_password")?.value||"").trim();
        const h={"Content-Type":"application/json"}; if(pwd) h["X-Admin-Password"]=pwd; return h;
      }

      // ----- APPLY (les config -> UI) -----
      function apply(cfg, tick){
        lastCfg = cfg;

        // Theme: messages
        const p = cfg?.theme?.messages?.primary   || {};
        const s = cfg?.theme?.messages?.secondary || {};
        $("#theme_p_size").value = String(p.size_rem ?? 1.0);
        $("#theme_p_weight").value = String(p.weight ?? 600);
        $("#theme_p_color").value = String(p.color ?? "#9aa4b2");
        $("#theme_s_size").value = String(s.size_rem ?? 1.0);
        $("#theme_s_weight").value = String(s.weight ?? 400);
        $("#theme_s_color").value = String(s.color ?? "#9aa4b2");

        // Digits preset
        $("#digits_size_preset").value = String(cfg?.theme?.digits?.size_vw ?? 14);

        // Debug-panelet (kort)
        if (debug) debug.textContent = JSON.stringify({cfg,tick},null,2);

        renderPreview();
      }

      // ----- SAVE (UI -> server) -----
      async function saveAll(){
        const body = {
          theme: {
            digits: { size_vw: Number($("#digits_size_preset").value || "14") },
            messages: {
              primary:   { size_rem: Number($("#theme_p_size").value || "1.0"), weight: Number($("#theme_p_weight").value || "600"), color: $("#theme_p_color").value },
              secondary: { size_rem: Number($("#theme_s_size").value || "1.0"), weight: Number($("#theme_s_weight").value || "400"), color: $("#theme_s_color").value }
            }
          }
        };
        const r=await fetch("/api/config",{method:"POST",headers:headers(),body:JSON.stringify(body)});
        if(!r.ok) throw new Error(await r.text());
        const js=await r.json();
        apply(js.config,js.tick); hint.textContent="Lagret"; setTimeout(()=>hint.textContent="",1500);
      }

      // ----- RESET (defaults fra server) -----
      async function resetView(){
        const d = await fetchDefaults();
        $("#digits_size_preset").value = String(d.theme?.digits?.size_vw ?? 14);
        $("#theme_p_size").value = String(d.theme?.messages?.primary?.size_rem ?? 1.0);
        $("#theme_p_weight").value = String(d.theme?.messages?.primary?.weight ?? 600);
        $("#theme_p_color").value = String(d.theme?.messages?.primary?.color ?? "#9aa4b2");
        $("#theme_s_size").value = String(d.theme?.messages?.secondary?.size_rem ?? 1.0);
        $("#theme_s_weight").value = String(d.theme?.messages?.secondary?.weight ?? 400);
        $("#theme_s_color").value = String(d.theme?.messages?.secondary?.color ?? "#9aa4b2");
        renderPreview();
        hint.textContent="Tilbakestilt (lagre for å aktivere)"; setTimeout(()=>hint.textContent="",2000);
      }

      // ----- PREVIEW -----
      function renderPreview(){
        const p = { size_rem: Number($("#theme_p_size").value||"1.0"), weight: Number($("#theme_p_weight").value||"600"), color: $("#theme_p_color").value };
        const s = { size_rem: Number($("#theme_s_size").value||"1.0"), weight: Number($("#theme_s_weight").value||"400"), color: $("#theme_s_color").value };
        const vw = Number($("#digits_size_preset").value || "14");
        $("#pv_digits").style.fontSize = `${vw}vw`;

        function style(el, m){ el.style.fontSize = `${m.size_rem}rem`; el.style.fontWeight = String(m.weight); el.style.color = m.color; }
        style($("#pv_prim_above"), p); style($("#pv_sec_above"), s);
        style($("#pv_prim_below"), p); style($("#pv_sec_below"), s);

        const showAbove = (lastCfg?.messages_position || "below") === "above";
        $("#pv_msgs_above").style.display = showAbove ? "block" : "none";
        $("#pv_msgs_below").style.display = showAbove ? "none"  : "block";

        const tt = (lastCfg?.show_target_time && (lastCfg?.tick?.target_hhmm || lastCfg?.target_hhmm)) ? " 19:00" : "";
        $("#pv_prim_above").textContent = showAbove ? ((lastCfg?.message_primary || "Velkommen!") + (lastCfg?.target_time_after==="primary"?tt:"")) : "";
        $("#pv_sec_above").textContent  = showAbove ? ((lastCfg?.message_secondary || "Vi starter igjen kl:") + (lastCfg?.target_time_after==="secondary"?tt:"")) : "";
        $("#pv_prim_below").textContent = !showAbove ? ((lastCfg?.message_primary || "Velkommen!") + (lastCfg?.target_time_after==="primary"?tt:"")) : "";
        $("#pv_sec_below").textContent  = !showAbove ? ((lastCfg?.message_secondary || "Vi starter igjen kl:") + (lastCfg?.target_time_after==="secondary"?tt:"")) : "";
      }

      // ----- Synk-pille (uendret struktur; enkel polling) -----
      async function updateSyncPill(){
        try{
          const r = await fetch("/debug/view-heartbeat"); const js = await r.json();
          const hb = js.heartbeat || {}; const age = hb.age_seconds ?? 9999;
          const viewRev = hb.rev || 0;
          const cfgRev = (lastCfg && lastCfg._updated_at) ? lastCfg._updated_at : 0;
          if (age > 30 || !hb.ts_iso) { pill.textContent = "Synk: visning offline"; pill.className = "pill off"; }
          else if (viewRev >= cfgRev) { pill.textContent = `Synk: OK (rev ${viewRev})`; pill.className = "pill ok"; }
          else { pill.textContent = `Synk: venter (view ${viewRev} < cfg ${cfgRev})`; pill.className = "pill warn"; }
        } catch(e){ pill.textContent = "Synk: —"; pill.className = "pill off"; }
      }

      // ----- Init / Events -----
      $("#btn_save").addEventListener("click",()=>saveAll().catch(e=>alert(e.message)));
      $("#btn_refresh").addEventListener("click",()=>loadAll().catch(e=>alert(e.message)));
      $("#btn_reset_view").addEventListener("click",()=>resetView().catch(e=>alert(e.message)));
      ["theme_p_size","theme_p_weight","theme_p_color","theme_s_size","theme_s_weight","theme_s_color","digits_size_preset"].forEach(id=>{
        document.getElementById(id).addEventListener("input", renderPreview);
      });

      async function loadAll(){
        const r=await fetch("/api/config"); const js=await r.json();
        // pakk inn tick litt for PV-tekst
        js.config.tick = js.tick;
        apply(js.config, js.tick); updateSyncPill();
      }

      loadAll().catch(console.error);
      setInterval(updateSyncPill, 3000);
    })();
  </script>
</body>
</html>
