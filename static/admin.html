<!doctype html>
<html lang="no">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Countdown ¬∑ Admin</title>
    <link rel="stylesheet" href="/static/css/ui.css" />
    <style>
      .actions {
        position: sticky;
        top: 0;
        z-index: 5;
        padding: 10px 16px;
        background: rgba(11, 15, 20, 0.85);
        backdrop-filter: blur(8px);
        border-bottom: 1px solid var(--border);
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .pill {
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 0.85rem;
        border: 1px solid var(--border);
      }
      .ok {
        color: #0b0f14;
        background: #69db7c;
        border-color: transparent;
      }
      .warn {
        color: #0b0f14;
        background: #ffd166;
        border-color: transparent;
      }
      .off {
        color: #e6edf3;
        background: #374151;
      }
      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
      }
      .hint-inline {
        font-size: 0.85rem;
        opacity: 0.9;
        margin-left: 6px;
      }
      .preview {
        background: #0b0f14;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 14px;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .pv-box {
        width: 100%;
        max-width: 800px;
        aspect-ratio: 16/8;
        border: 1px solid var(--border);
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 10px;
      }
      .pv-digits {
        font-weight: 800;
        letter-spacing: 0.06em;
        font-size: clamp(4vw, 8vw, 10vw);
      }
      .tag {
        font-size: 0.8rem;
        color: var(--muted);
        border: 1px dashed var(--border);
        padding: 2px 6px;
        border-radius: 6px;
      }
    </style>
  </head>
  <body>
    <header id="admin_topbar" class="topbar">
      <div class="brand">Countdown ¬∑ Admin</div>
      <nav class="modes">
        <button type="button" class="mode-btn" data-mode="daily">Daglig</button>
        <button type="button" class="mode-preset" data-min="15">15 min</button>
        <button type="button" class="mode-preset" data-min="20">20 min</button>
        <button type="button" class="mode-btn" data-mode="clock">Klokke</button>
      </nav>

      <div id="save_status" class="status" aria-live="polite"></div>
    </header>

    <header>
      <h1>Countdown ¬∑ Admin</h1>
      <nav>
        <a href="/">Visning</a>
        <a class="active" href="/admin">Admin</a>
        <a href="/diag">Diagnose</a>
        <a href="/about">Om</a>
      </nav>
    </header>

    <div class="actions">
      <button id="btn_save" class="primary">Lagre</button>
      <button id="btn_refresh">Hent config</button>
      <button id="btn_reset_view">Tilbakestill visning</button>
      <span id="sync_pill" class="pill off">Synk: ‚Äî</span>
      <span id="save_hint" class="muted"></span>
    </div>

    <main class="grid">
      <!-- Modus -->
      <section class="card">
        <h2>Modus</h2>
        <label><input type="radio" name="mode" value="daily" /> Daglig klokkeslett</label>
        <input id="daily_time" type="time" step="60" />
        <br />
        <label><input type="radio" name="mode" value="once" /> Engangs-tidspunkt</label>
        <input id="once_at" type="datetime-local" />
        <br />
        <label><input type="radio" name="mode" value="duration" /> Varighet (manuell start)</label>
        <br />
        <label><input type="radio" name="mode" value="clock" /> Klokke</label>
        <p class="hint">Velg √©n modus. Lagre for at endring skal gjelde.</p>
        <p id="active_mode" class="muted">Aktiv modus: ‚Äî</p>
      </section>

      <!-- Start med varighet -->
      <section class="card">
        <h2>Start med varighet</h2>
        <div class="row">
          <button class="preset" data-min="5">+5 min</button>
          <button class="preset" data-min="10">+10 min</button>
          <button class="preset" data-min="15">+15 min</button>
          <button class="preset" data-min="20">+20 min</button>
          <button class="preset" data-min="30">+30 min</button>
          <label
            >Varighet (minutter)
            <input id="start_minutes" type="number" min="1" step="1" value="10"
          /></label>
          <button id="btn_start" class="primary">Start nedtelling n√•</button>
          <button id="btn_stop">Stopp</button>
        </div>
        <p class="hint">Starter alltid varighetsmodus umiddelbart.</p>
      </section>

      <!-- Meldinger (innhold) -->
      <section class="card">
        <h2>Meldinger</h2>
        <label><input id="show_message_primary" type="checkbox" /> Vis hovedmelding</label>
        <textarea id="message_primary" rows="2" placeholder="Velkommen !"></textarea>
        <label><input id="show_message_secondary" type="checkbox" /> Vis sekund√¶r melding</label>
        <input id="message_secondary" type="text" placeholder="Vi starter igjen kl:" />
      </section>

      <!-- Varsler / blink -->
      <section class="card">
        <h2>Varsler / blink</h2>
        <div class="row">
          <label
            >Gult ved (min igjen) <input id="warn_minutes" type="number" min="0" step="1"
          /></label>
          <label
            >R√∏dt ved (min igjen) <input id="alert_minutes" type="number" min="0" step="1"
          /></label>
          <label
            >Blink de siste (sek) <input id="blink_seconds" type="number" min="0" step="1"
          /></label>
          <label
            >Vis minus-tid (min etterp√•) <input id="overrun_minutes" type="number" min="0" step="1"
          /></label>
        </div>
      </section>

      <!-- Visning / oppf√∏rsel -->
      <section class="card">
        <h2>Visning / oppf√∏rsel</h2>
        <div class="help">
          Terskel: ved ‚â• verdi vises <strong>H:MM:SS</strong>, ellers
          <strong>MM:SS</strong> (70‚Üí2:00:00, 300‚Üí120:00).
        </div>
        <label><input id="use_phase_colors" type="checkbox" /> Fargelegg ved gult/r√∏dt</label>
        <label><input id="use_blink" type="checkbox" /> Blink de siste sekundene</label>

        <div class="row">
          <label>Farge normal <input id="color_normal" type="color" value="#e6edf3" /></label
          ><span id="c_contrast_normal" class="hint-inline"></span>
        </div>
        <div class="row">
          <label>Farge gul <input id="color_warn" type="color" value="#ffd166" /></label
          ><span id="c_contrast_warn" class="hint-inline"></span>
        </div>
        <div class="row">
          <label>Farge r√∏d <input id="color_alert" type="color" value="#ff6b6b" /></label
          ><span id="c_contrast_alert" class="hint-inline"></span>
        </div>
        <div class="row">
          <label>Farge minus-tid <input id="color_over" type="color" value="#9ad0ff" /></label
          ><span id="c_contrast_over" class="hint-inline"></span>
        </div>

        <label><input id="show_target_time" type="checkbox" /> Vis m√•l-klokkeslett</label>
        <label
          >Plassering av m√•l-klokkeslett
          <select id="target_time_after">
            <option value="primary">etter hovedmelding</option>
            <option value="secondary">etter sekund√¶r melding</option>
          </select>
        </label>
        <label
          >Plassering av meldinger
          <select id="messages_position">
            <option value="above">over nedtellingen</option>
            <option value="below">under nedtellingen</option>
          </select>
        </label>
        <label
          >Tidsformat ‚Üí H:MM:SS n√•r over (min)
          <input id="hms_threshold_minutes" type="number" min="0" max="720" step="1" value="60" />
        </label>
      </section>

      <!-- Utseende ‚Äì Meldinger -->
      <section class="card">
        <h2>Utseende ‚Äì Meldinger</h2>
        <div class="row">
          <strong>Hovedmelding</strong>
          <label
            >St√∏rrelse (rem) <input id="theme_p_size" type="number" step="0.1" min="0.6" max="6.0"
          /></label>
          <label
            >Vekt
            <select id="theme_p_weight">
              <option>300</option>
              <option>400</option>
              <option>500</option>
              <option selected>600</option>
              <option>700</option>
              <option>800</option>
              <option>900</option>
            </select>
          </label>
          <label>Farge <input id="theme_p_color" type="color" /></label>
          <span id="m_contrast_p" class="hint-inline tag"></span>
        </div>
        <div class="row">
          <strong>Sekund√¶r</strong>
          <label
            >St√∏rrelse (rem) <input id="theme_s_size" type="number" step="0.1" min="0.6" max="6.0"
          /></label>
          <label
            >Vekt
            <select id="theme_s_weight">
              <option>300</option>
              <option selected>400</option>
              <option>500</option>
              <option>600</option>
              <option>700</option>
              <option>800</option>
              <option>900</option>
            </select>
          </label>
          <label>Farge <input id="theme_s_color" type="color" /></label>
          <span id="m_contrast_s" class="hint-inline tag"></span>
        </div>
        <div class="row">
          <strong>Digits</strong>
          <label
            >St√∏rrelse
            <select id="digits_size_preset">
              <option value="10">Liten</option>
              <option value="14">Normal</option>
              <option value="19">Stor</option>
              <option value="23">Ekstra stor</option>
            </select>
          </label>
        </div>
      </section>

      <!-- Utseende ‚Äì Bakgrunn (visningen) -->
      <section class="card">
        <h2>Utseende ‚Äì Bakgrunn</h2>
        <div class="row">
          <label
            >Preset
            <select id="bg_preset">
              <option value="none">(ingen)</option>
              <option value="dark-solid">M√∏rk ensfarget</option>
              <option value="dark-grad">M√∏rk gradient</option>
              <option value="photo-tint">Foto m/tint</option>
            </select>
          </label>
          <button id="btn_apply_preset">Bruk preset</button>
        </div>
        <label><input type="radio" name="bg_mode" value="solid" /> Ensfarget</label>
        <label><input type="radio" name="bg_mode" value="gradient" /> Gradient</label>
        <label><input type="radio" name="bg_mode" value="image" /> Bilde</label>

        <div id="bg_solid_cfg">
          <label>Farge <input id="bg_solid_color" type="color" value="#0b0f14" /></label>
        </div>
        <div id="bg_grad_cfg">
          <label>Fra <input id="bg_grad_from" type="color" value="#142033" /></label>
          <label>Til <input id="bg_grad_to" type="color" value="#0b0f14" /></label>
          <label
            >Vinkel (¬∞)
            <input id="bg_grad_angle" type="number" min="0" max="360" step="1" value="180"
          /></label>
        </div>
        <div id="bg_img_cfg">
          <label>Bilde-URL <input id="bg_img_url" type="url" placeholder="https://..." /></label>
          <label
            >Fit
            <select id="bg_img_fit">
              <option>cover</option>
              <option>contain</option>
            </select>
          </label>
          <label
            >Opacity (0‚Äì1)
            <input id="bg_img_op" type="number" min="0" max="1" step="0.05" value="1"
          /></label>
          <label>Tint-farge <input id="bg_img_tint" type="color" value="#000000" /></label>
          <label
            >Tint-opacity (0‚Äì1)
            <input id="bg_img_tint_op" type="number" min="0" max="1" step="0.05" value="0"
          /></label>
        </div>
      </section>
      <!-- Overlays (logo/grafikk) -->
      <section class="card" id="card_overlays">
        <h2>Overlays (logo/grafikk)</h2>

        <div class="row">
          <label>
            Lagrede overlays
            <select id="ov_select" style="min-width: 240px"></select>
          </label>
          <button id="ov_add">Ny</button>
          <button id="ov_dup">Dupliser</button>
          <button id="ov_del">Slett</button>
        </div>

        <div class="row">
          <label>ID <input id="ov_id" placeholder="logo-main" /></label>
          <label
            >Type
            <select id="ov_type">
              <option value="image">Bilde</option>
            </select>
          </label>
          <label
            >URL <input id="ov_url" type="url" placeholder="/static/img/logo.svg" size="36"
          /></label>
        </div>

        <div class="row">
          <label
            >St√∏rrelse (vmin)
            <input id="ov_size" type="number" step="1" min="2" max="200" value="30"
          /></label>
          <label
            >Opacity (0‚Äì1)
            <input id="ov_opacity" type="number" step="0.05" min="0" max="1" value="1"
          /></label>
          <label
            >Z-index <input id="ov_z" type="number" step="1" min="1" max="999" value="10"
          /></label>
        </div>

        <div class="row">
          <label
            >Plassering
            <select id="ov_pos">
              <option value="top-left">√òvre venstre</option>
              <option value="top-center">√òvre midtstilt</option>
              <option value="top-right">√òvre h√∏yre</option>
              <option value="center-left">Midten venstre</option>
              <option value="center">Midten</option>
              <option value="center-right">Midten h√∏yre</option>
              <option value="bottom-left">Nedre venstre</option>
              <option value="bottom-center">Nedre midtstilt</option>
              <option value="bottom-right">Nedre h√∏yre</option>
            </select>
          </label>
          <label>Offset X (vw) <input id="ov_off_vw" type="number" step="0.5" value="2" /></label>
          <label>Offset Y (vh) <input id="ov_off_vh" type="number" step="0.5" value="2" /></label>
          <div class="row">
            <label
              >Tint farge
              <input id="ov_tint_color" type="color" value="#000000" />
            </label>
            <label
              >Tint opacity (0‚Äì1)
              <input id="ov_tint_opacity" type="number" step="0.05" min="0" max="1" value="0" />
            </label>
            <label
              >Blend-modus
              <select id="ov_tint_blend">
                <option value="normal">Normal</option>
                <option value="multiply" selected>Multiply</option>
                <option value="screen">Screen</option>
                <option value="overlay">Overlay</option>
                <option value="soft-light">Soft light</option>
                <option value="hard-light">Hard light</option>
              </select>
            </label>
          </div>
        </div>

        <div class="row">
          <label><input id="ov_in_clock" type="checkbox" /> Vis i klokkemodus</label>
          <label><input id="ov_in_countdown" type="checkbox" checked /> Vis i nedtelling</label>
        </div>
      </section>

      <!-- Klokke -->
      <section class="card">
        <h2>Klokke</h2>
        <div class="row">
          <label><input id="clk_with_seconds" type="checkbox" /> Vis sekunder</label>

          <label
            >Farge
            <input id="clk_color" type="color" value="#e6edf3" />
            <small id="clk_contrast" class="hint" style="margin-left: 0.5rem"></small>
          </label>

          <label
            >St√∏rrelse (vmin)
            <input id="clk_size_vmin" type="number" min="6" max="60" step="1" value="12" />
          </label>

          <label
            >Plassering
            <select id="clk_position">
              <option value="center">Midtstilt</option>
              <option value="top-center">√òvre midtstilt</option>
              <option value="bottom-center">Nedre midtstilt</option>
              <option value="top-left">√òvre venstre</option>
              <option value="top-right">√òvre h√∏yre</option>
              <option value="bottom-left">Nedre venstre</option>
              <option value="bottom-right">Nedre h√∏yre</option>
            </select>
          </label>

          <label
            >Plassering av klokke-tekst
            <select id="clk_msg_position">
              <option value="right">Til h√∏yre</option>
              <option value="left">Til venstre</option>
              <option value="above">Over</option>
              <option value="below">Under</option>
            </select>
          </label>

          <label
            >Justering klokke-tekst
            <select id="clk_msg_align">
              <option value="start">Venstre</option>
              <option value="center" selected>Midtstilt</option>
              <option value="end">H√∏yre</option>
            </select>
          </label>

          <label
            ><input id="clk_use_own_msgs" type="checkbox" /> Bruk egne meldinger i
            klokkemodus</label
          >

          <textarea
            id="clk_msg_primary"
            rows="2"
            placeholder="(valgfri) Klokkens hovedmelding"
          ></textarea>
          <input
            id="clk_msg_secondary"
            type="text"
            placeholder="(valgfri) Klokkens sekund√¶rmelding"
          />
        </div>

        <p class="hint">
          Klokken bruker temaets bakgrunn (Theme ‚Üí Background). <code>vmin</code> gir konsistent
          st√∏rrelse i b√•de st√•ende og liggende format.
        </p>
      </section>
    </main>

    <script>
      // Debounce
      function debounce(fn, ms = 600) {
        let t;
        return (...a) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...a), ms);
        };
      }
      let overlaysLocal = []; // lokal redigerbar liste

      function overlayDefaults() {
        return {
          id: `logo-${Date.now()}`,
          type: "image",
          url: "",
          position: "top-right",
          size_vmin: 30,
          opacity: 1.0,
          offset_vw: 2,
          offset_vh: 2,
          z_index: 10,
          visible_in: ["clock", "countdown"],
          tint: { color: "#000000", opacity: 0.0, blend: "multiply" }, // NYTT
        };
      }

      // Dyp flette (liten, trygg)
      function deepMerge(base, patch) {
        if (patch == null || typeof patch !== "object") return base;
        const out = Array.isArray(base) ? [...base] : { ...base };
        for (const [k, v] of Object.entries(patch)) {
          if (v && typeof v === "object" && !Array.isArray(v)) {
            out[k] = deepMerge(out[k] ?? {}, v);
          } else {
            out[k] = v;
          }
        }
        return out;
      }

      (function () {
        const $ = (s) => document.querySelector(s);
        const $$ = (s) => Array.from(document.querySelectorAll(s));
        const pill = $("#sync_pill"),
          hint = $("#save_hint");
        let lastCfg = null,
          defaultsCache = null;

        // -------- helpers --------
        const val = (sel, def = "") => document.querySelector(sel)?.value ?? def;
        const checked = (sel) => !!document.querySelector(sel)?.checked;
        const num = (sel, def = 0) => {
          const v = parseFloat(val(sel, ""));
          return Number.isFinite(v) ? v : def;
        };

        async function fetchDefaults() {
          if (defaultsCache) return defaultsCache;
          const r = await fetch("/api/defaults");
          const js = await r.json();
          defaultsCache = js.defaults;
          return defaultsCache;
        }
        function headers() {
          const pwd = ($("#admin_password")?.value || "").trim();
          const h = { "Content-Type": "application/json" };
          if (pwd) h["X-Admin-Password"] = pwd;
          return h;
        }
        const selMode = () => $$("input[name=mode]:checked")[0]?.value || "daily";
        const selBgMode = () => $$("input[name=bg_mode]:checked")[0]?.value || "solid";

        function lock() {
          const m = selMode();
          const bg = selBgMode();

          // Modus-avhengig
          const daily = $("#daily_time"),
            onceAt = $("#once_at");
          //if (daily) daily.disabled = m !== "daily";
          if (onceAt) onceAt.disabled = m !== "once";

          // Bakgrunn (visning)
          $("#bg_solid_cfg") &&
            ($("#bg_solid_cfg").style.display = bg === "solid" ? "block" : "none");
          $("#bg_grad_cfg") &&
            ($("#bg_grad_cfg").style.display = bg === "gradient" ? "block" : "none");
          $("#bg_img_cfg") && ($("#bg_img_cfg").style.display = bg === "image" ? "block" : "none");

          // Klokke-felter er valgfrie ‚Äì hvis de finnes, deaktiver utenom clock-modus
          const isClock = m === "clock";
          const own = !!$("#clk_use_own_msgs")?.checked;
          $("#clk_with_seconds") && ($("#clk_with_seconds").disabled = false);
          $("#clk_color") && ($("#clk_color").disabled = false);
          $("#clk_size_vmin") && ($("#clk_size_vmin").disabled = false);
          $("#clk_position") && ($("#clk_position").disabled = false);
          $("#clk_msg_position") && ($("#clk_msg_position").disabled = false);
          $("#clk_msg_align") && ($("#clk_msg_align").disabled = false);
          $("#clk_use_own_msgs") && ($("#clk_use_own_msgs").disabled = false);
          $("#clk_msg_primary") && ($("#clk_msg_primary").disabled = !own);
          $("#clk_msg_secondary") && ($("#clk_msg_secondary").disabled = !own);
        }
        // -------- kontrast-hint (som f√∏r) --------
        const hexToRgb = (h) => {
          const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec((h || "").trim());
          return m ? [parseInt(m[1], 16), parseInt(m[2], 16), parseInt(m[3], 16)] : [230, 237, 243];
        };
        const luminance = ([r, g, b]) => {
          const a = [r, g, b].map((v) => {
            v /= 255;
            return v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4);
          });
          return 0.2126 * a[0] + 0.7152 * a[1] + 0.0722 * a[2];
        };
        const contrast = (c1, c2) => {
          const L1 = luminance(hexToRgb(c1)),
            L2 = luminance(hexToRgb(c2));
          const [hi, lo] = L1 > L2 ? [L1, L2] : [L2, L1];
          return (hi + 0.05) / (lo + 0.05);
        };
        function currentPreviewBgColor() {
          const bg = selBgMode();
          if (bg === "solid") return val("#bg_solid_color", "#0b0f14");
          if (bg === "gradient") return val("#bg_grad_to", "#0b0f14");
          return val("#bg_img_tint", "#000000");
        }
        function updateDigitContrastHints() {
          const bg = currentPreviewBgColor();
          const set = (id, color) => {
            const el = $(id);
            if (!el) return;
            const ratio = contrast(color, bg);
            el.textContent = `kontrast ${ratio.toFixed(2)}${ratio >= 3 ? " ‚úî" : " ‚ö†"}`;
            el.style.color = ratio >= 3 ? "#69db7c" : "#ffd166";
          };
          set("#c_contrast_normal", val("#color_normal", "#e6edf3"));
          set("#c_contrast_warn", val("#color_warn", "#ffd166"));
          set("#c_contrast_alert", val("#color_alert", "#ff6b6b"));
          set("#c_contrast_over", val("#color_over", "#9ad0ff"));
        }
        function updateMessageContrastHints() {
          const bg = currentPreviewBgColor();
          const set = (id, color) => {
            const el = $(id);
            if (!el) return;
            const ratio = contrast(color, bg);
            el.textContent = `${ratio.toFixed(2)}${ratio >= 3 ? " ‚úî" : " ‚ö†"}`;
            el.style.color = ratio >= 3 ? "#69db7c" : "#ffd166";
          };
          $("#m_contrast_p") && set("#m_contrast_p", val("#theme_p_color", "#9aa4b2"));
          $("#m_contrast_s") && set("#m_contrast_s", val("#theme_s_color", "#9aa4b2"));
        }

        function updateClockContrastHint() {
          const bg = currentPreviewBgColor(); // solid: solid, gradient: 'to', image: tint
          const color = val("#clk_color", "#e6edf3");
          const el = $("#clk_contrast");
          if (!el) return;
          const ratio = contrast(color, bg);
          el.textContent = `kontrast ${ratio.toFixed(2)}${ratio >= 3 ? " ‚úî" : " ‚ö†"}`;
          el.style.color = ratio >= 3 ? "#69db7c" : "#ffd166";
        }

        // -------- apply() --------
        function apply(cfg, tick) {
          lastCfg = cfg;

          // Modus + info
          ($(`input[name=mode][value=${cfg.mode || "daily"}]`) || {}).checked = true;
          $("#daily_time") && ($("#daily_time").value = cfg.daily_time || "");
          $("#once_at") && ($("#once_at").value = (cfg.once_at || "").replace("Z", ""));
          $("#active_mode") &&
            ($("#active_mode").textContent =
              `Aktiv modus: ${cfg.mode} ¬∑ Fase: ${tick?.mode || "‚Äî"} (${tick?.state || "‚Äî"})`);

          // Meldinger
          $("#show_message_primary") &&
            ($("#show_message_primary").checked = !!cfg.show_message_primary);
          $("#show_message_secondary") &&
            ($("#show_message_secondary").checked = !!cfg.show_message_secondary);
          $("#message_primary") && ($("#message_primary").value = cfg.message_primary || "");
          $("#message_secondary") && ($("#message_secondary").value = cfg.message_secondary || "");

          // Varsler/blink
          $("#warn_minutes") && ($("#warn_minutes").value = cfg.warn_minutes ?? 4);
          $("#alert_minutes") && ($("#alert_minutes").value = cfg.alert_minutes ?? 2);
          $("#blink_seconds") && ($("#blink_seconds").value = cfg.blink_seconds ?? 10);
          $("#overrun_minutes") && ($("#overrun_minutes").value = cfg.overrun_minutes ?? 1);

          // Visning/oppf√∏rsel
          $("#use_phase_colors") && ($("#use_phase_colors").checked = !!cfg.use_phase_colors);
          $("#use_blink") && ($("#use_blink").checked = !!cfg.use_blink);
          $("#color_normal") && ($("#color_normal").value = cfg.color_normal || "#e6edf3");
          $("#color_warn") && ($("#color_warn").value = cfg.color_warn || "#ffd166");
          $("#color_alert") && ($("#color_alert").value = cfg.color_alert || "#ff6b6b");
          $("#color_over") && ($("#color_over").value = cfg.color_over || "#9ad0ff");
          $("#show_target_time") && ($("#show_target_time").checked = !!cfg.show_target_time);
          $("#target_time_after") &&
            ($("#target_time_after").value = cfg.target_time_after || "secondary");
          $("#messages_position") &&
            ($("#messages_position").value = cfg.messages_position || "below");
          $("#hms_threshold_minutes") &&
            ($("#hms_threshold_minutes").value = cfg.hms_threshold_minutes ?? 60);

          // Theme
          const p = cfg?.theme?.messages?.primary || {};
          const s = cfg?.theme?.messages?.secondary || {};
          $("#theme_p_size") && ($("#theme_p_size").value = String(p.size_rem ?? 1.0));
          $("#theme_p_weight") && ($("#theme_p_weight").value = String(p.weight ?? 600));
          $("#theme_p_color") && ($("#theme_p_color").value = String(p.color ?? "#9aa4b2"));
          $("#theme_s_size") && ($("#theme_s_size").value = String(s.size_rem ?? 1.0));
          $("#theme_s_weight") && ($("#theme_s_weight").value = String(s.weight ?? 400));
          $("#theme_s_color") && ($("#theme_s_color").value = String(s.color ?? "#9aa4b2"));
          $("#digits_size_preset") &&
            ($("#digits_size_preset").value = String(cfg?.theme?.digits?.size_vw ?? 14));
          // Overlays
          overlaysLocal = Array.isArray(cfg.overlays)
            ? JSON.parse(JSON.stringify(cfg.overlays))
            : [];
          renderOverlaysUI();

          // Bakgrunn (visningen)
          const bg = cfg?.theme?.background || {};
          ($(`input[name=bg_mode][value=${bg.mode || "solid"}]`) || {}).checked = true;
          $("#bg_solid_color") && ($("#bg_solid_color").value = bg.solid?.color || "#0b0f14");
          $("#bg_grad_from") && ($("#bg_grad_from").value = bg.gradient?.from || "#142033");
          $("#bg_grad_to") && ($("#bg_grad_to").value = bg.gradient?.to || "#0b0f14");
          $("#bg_grad_angle") && ($("#bg_grad_angle").value = bg.gradient?.angle_deg ?? 180);
          $("#bg_img_url") && ($("#bg_img_url").value = bg.image?.url || "");
          $("#bg_img_fit") && ($("#bg_img_fit").value = bg.image?.fit || "cover");
          $("#bg_img_op") && ($("#bg_img_op").value = bg.image?.opacity ?? 1);
          $("#bg_img_tint") && ($("#bg_img_tint").value = bg.image?.tint?.color || "#000000");
          $("#bg_img_tint_op") && ($("#bg_img_tint_op").value = bg.image?.tint?.opacity ?? 0);

          // Ny: klokke (top-level) ‚Äì hvis feltene finnes
          const clk = cfg?.clock || {};
          $("#clk_with_seconds") && ($("#clk_with_seconds").checked = !!clk.with_seconds);
          $("#clk_color") && ($("#clk_color").value = clk.color || "#e6edf3");
          $("#clk_size_vmin") && ($("#clk_size_vmin").value = clk.size_vmin ?? 12);
          $("#clk_position") && ($("#clk_position").value = clk.position || "center");
          $("#clk_msg_position") &&
            ($("#clk_msg_position").value = cfg?.clock?.messages_position || "right");
          $("#clk_msg_align") &&
            ($("#clk_msg_align").value = cfg?.clock?.messages_align || "center");
          $("#clk_use_own_msgs") &&
            ($("#clk_use_own_msgs").checked = !!cfg?.clock?.use_clock_messages);
          $("#clk_msg_primary") &&
            ($("#clk_msg_primary").value = cfg?.clock?.message_primary || "");
          $("#clk_msg_secondary") &&
            ($("#clk_msg_secondary").value = cfg?.clock?.message_secondary || "");
          // Overlays ‚Äì bindings
          $("#ov_select") &&
            $("#ov_select").addEventListener("change", () => {
              const cur = currentOverlay();
              if (cur) fillOverlayFields(cur);
            });
          $("#ov_add") && $("#ov_add").addEventListener("click", addOverlay);
          $("#ov_dup") && $("#ov_dup").addEventListener("click", dupOverlay);
          $("#ov_del") && $("#ov_del").addEventListener("click", delOverlay);

          [
            "#ov_id",
            "#ov_type",
            "#ov_url",
            "#ov_pos",
            "#ov_size",
            "#ov_opacity",
            "#ov_z",
            "#ov_off_vw",
            "#ov_off_vh",
            "#ov_in_clock",
            "#ov_in_countdown",
            "#ov_tint_color",
            "#ov_tint_opacity",
            "#ov_tint_blend", // ‚Üê NYTT
          ].forEach((sel) => {
            const el = $(sel);
            el && el.addEventListener("input", commitOverlay);
          });

          updateClockContrastHint();

          lock();
          updateDigitContrastHints();
          updateMessageContrastHints();
        }

        // -------- I/O --------
        async function loadAll() {
          const r = await fetch("/api/config");
          const js = await r.json();
          js.config.tick = js.tick;
          apply(js.config, js.tick);
          pushPreview();
          hint && (hint.textContent = "Status oppdatert");
          setTimeout(() => {
            if (hint) hint.textContent = "";
          }, 1200);
        }
        function buildPatch() {
          const m = selMode();

          // Bygg clock-del, men bare hvis feltene finnes ‚Äì ellers bruk lastCfg.clock som fallback
          const clock = (function () {
            const hasClockFields =
              $("#clk_with_seconds") ||
              $("#clk_color") ||
              $("#clk_size_vmin") ||
              $("#clk_position") ||
              $("#clk_msg_position") ||
              $("#clk_msg_align") ||
              $("#clk_use_own_msgs") ||
              $("#clk_msg_primary") ||
              $("#clk_msg_secondary");

            if (hasClockFields) {
              return {
                with_seconds: checked("#clk_with_seconds"),
                color: val("#clk_color", "#e6edf3"),
                size_vmin: Number(val("#clk_size_vmin", "12")),
                position: val("#clk_position", "center"),

                messages_position: val("#clk_msg_position", "right"),
                messages_align: val("#clk_msg_align", "center"),
                use_clock_messages: checked("#clk_use_own_msgs"),
                message_primary: val("#clk_msg_primary", ""),
                message_secondary: val("#clk_msg_secondary", ""),
              };
            }
            return lastCfg?.clock || {};
          })();

          const body = {
            mode: m,
            daily_time: val("#daily_time"),
            once_at: val("#once_at"),
            overlays: overlaysLocal,

            // meldinger
            show_message_primary: checked("#show_message_primary"),
            show_message_secondary: checked("#show_message_secondary"),
            message_primary: val("#message_primary"),
            message_secondary: val("#message_secondary"),

            // varsler/blink
            warn_minutes: num("#warn_minutes", 4),
            alert_minutes: num("#alert_minutes", 2),
            blink_seconds: num("#blink_seconds", 10),
            overrun_minutes: num("#overrun_minutes", 1),

            // visning/oppf√∏rsel
            use_phase_colors: checked("#use_phase_colors"),
            use_blink: checked("#use_blink"),
            color_normal: val("#color_normal", "#e6edf3"),
            color_warn: val("#color_warn", "#ffd166"),
            color_alert: val("#color_alert", "#ff6b6b"),
            color_over: val("#color_over", "#9ad0ff"),
            show_target_time: checked("#show_target_time"),
            target_time_after: val("#target_time_after", "secondary"),
            messages_position: val("#messages_position", "below"),
            hms_threshold_minutes: parseInt(val("#hms_threshold_minutes", "60"), 10),

            // theme (digits/messages/bg)
            theme: {
              digits: { size_vw: Number(val("#digits_size_preset", "14")) },
              messages: {
                primary: {
                  size_rem: Number(val("#theme_p_size", "1.0")),
                  weight: Number(val("#theme_p_weight", "600")),
                  color: val("#theme_p_color", "#9aa4b2"),
                },
                secondary: {
                  size_rem: Number(val("#theme_s_size", "1.0")),
                  weight: Number(val("#theme_s_weight", "400")),
                  color: val("#theme_s_color", "#9aa4b2"),
                },
              },
              background: {
                mode: selBgMode(),
                solid: { color: val("#bg_solid_color", "#0b0f14") },
                gradient: {
                  from: val("#bg_grad_from", "#142033"),
                  to: val("#bg_grad_to", "#0b0f14"),
                  angle_deg: Number(val("#bg_grad_angle", "180")),
                },
                image: {
                  url: val("#bg_img_url", ""),
                  fit: val("#bg_img_fit", "cover"),
                  opacity: Number(val("#bg_img_op", "1")),
                  tint: {
                    color: val("#bg_img_tint", "#000000"),
                    opacity: Number(val("#bg_img_tint_op", "0")),
                  },
                },
              },
            },

            // ny topp-n√∏kkel
            clock,
          };

          return body;
        }
        function ovSel() {
          return document.getElementById("ov_select");
        }
        function ovIdx() {
          return Math.max(0, ovSel().selectedIndex);
        }
        function currentOverlay() {
          return overlaysLocal[ovIdx()] || null;
        }

        function renderOverlaysUI(desiredIndex) {
          const sel = ovSel();
          if (!sel) return;

          // bevar eksisterende index hvis ikke eksplisitt gitt
          const prev = Number.isInteger(desiredIndex) ? desiredIndex : sel.selectedIndex;

          sel.innerHTML = "";
          overlaysLocal.forEach((o, i) => {
            const opt = document.createElement("option");
            opt.value = String(i);
            opt.textContent = o.id || `(overlay ${i + 1})`;
            sel.appendChild(opt);
          });

          const idx = Math.max(0, Math.min(sel.options.length - 1, prev >= 0 ? prev : 0));
          sel.selectedIndex = idx;

          const cur = overlaysLocal[idx] || overlayDefaults();
          fillOverlayFields(cur);
        }

        function fillOverlayFields(o) {
          $("#ov_id").value = o.id || "";
          $("#ov_type").value = o.type || "image";
          $("#ov_url").value = o.url || "";
          $("#ov_pos").value = o.position || "top-right";
          $("#ov_size").value = String(o.size_vmin ?? 12);
          $("#ov_opacity").value = String(o.opacity ?? 1);
          $("#ov_z").value = String(o.z_index ?? 10);
          $("#ov_off_vw").value = String(o.offset_vw ?? 2);
          $("#ov_off_vh").value = String(o.offset_vh ?? 2);
          $("#ov_in_clock").checked = !!(o.visible_in || []).includes("clock");
          $("#ov_in_countdown").checked = !!(o.visible_in || []).some((v) => v !== "clock");
          $("#ov_tint_color").value = o?.tint?.color || "#000000";
          $("#ov_tint_opacity").value = String(o?.tint?.opacity ?? 0);
          $("#ov_tint_blend").value = o?.tint?.blend || "multiply";
        }

        function readOverlayFields() {
          const vis = [];
          if ($("#ov_in_clock").checked) vis.push("clock");
          if ($("#ov_in_countdown").checked) vis.push("countdown");
          return {
            id: ($("#ov_id").value || "").trim(),
            type: $("#ov_type").value || "image",
            url: ($("#ov_url").value || "").trim(),
            position: $("#ov_pos").value || "top-right",
            size_vmin: Number($("#ov_size").value || "12"),
            opacity: Number($("#ov_opacity").value || "1"),
            z_index: Number($("#ov_z").value || "10"),
            offset_vw: Number($("#ov_off_vw").value || "2"),
            offset_vh: Number($("#ov_off_vh").value || "2"),
            visible_in: vis.length ? vis : ["countdown", "clock"],
            tint: {
              color: $("#ov_tint_color").value || "#000000",
              opacity: Number($("#ov_tint_opacity").value || "0"),
              blend: $("#ov_tint_blend").value || "multiply",
            },
          };
        }

        function commitOverlay() {
          if (!overlaysLocal.length) return;
          overlaysLocal[ovIdx()] = readOverlayFields();
          pushPreviewDebounced(); // live preview
        }

        function addOverlay() {
          overlaysLocal.push(overlayDefaults());
          // velg ny (siste)
          renderOverlaysUI(overlaysLocal.length - 1);
          pushPreview();
        }

        function dupOverlay() {
          const cur = currentOverlay();
          if (!cur) return addOverlay();
          overlaysLocal.push({ ...cur, id: `${cur.id}-copy` });
          ovSel().selectedIndex = overlaysLocal.length - 1;
          renderOverlaysUI();
          pushPreview();
        }
        function delOverlay() {
          if (!overlaysLocal.length) return;
          overlaysLocal.splice(ovIdx(), 1);
          renderOverlaysUI();
          pushPreview();
        }

        async function saveAll() {
          const body = buildPatch();
          const r = await fetch("/api/config", {
            method: "POST",
            headers: headers(),
            body: JSON.stringify(body),
          });
          if (!r.ok) throw new Error(await r.text());
          const js = await r.json();
          apply(js.config, js.tick);
          hint && (hint.textContent = "Lagret");
          setTimeout(() => {
            if (hint) hint.textContent = "";
          }, 1200);
        }

        function getPreviewWin() {
          return document.getElementById("preview_frame")?.contentWindow || null;
        }

        function pushPreview() {
          const win = getPreviewWin();
          if (!win || !lastCfg) return;
          const patch = buildPatch();
          const simulated = deepMerge(lastCfg, patch);
          win.postMessage({ type: "preview-config", config: simulated }, "*");
        }

        // Debounced preview p√• alle input/endringer
        const pushPreviewDebounced = debounce(pushPreview, 300);
        document.addEventListener("input", pushPreviewDebounced, { passive: true });
        document.addEventListener("change", pushPreviewDebounced, { passive: true });

        // Kj√∏r √©n gang n√•r admin √•pner siden og f√∏rste config er lastet
        document.addEventListener("DOMContentLoaded", () => setTimeout(pushPreview, 50));

        // Send en gang n√•r preview-iframe er ferdig lastet
        function hookPreviewLoad() {
          const f = document.getElementById("preview_frame");
          if (!f) return; // DOM ikke klart enn√• (men DOMContentLoaded under fikser)
          f.addEventListener("load", () => setTimeout(pushPreview, 50), { once: true });
        }
        // N√•r hele DOM‚Äôen er klar: hook + f√∏rste push
        document.addEventListener("DOMContentLoaded", () => {
          hookPreviewLoad();
          setTimeout(pushPreview, 80);
        });

        async function patchMode(newMode) {
          try {
            const resp = await fetch("/api/config", {
              method: "POST",
              headers: headers(),
              body: JSON.stringify({ mode: newMode }),
            });
            if (!resp.ok) throw new Error(await resp.text());
            const js = await resp.json();
            lastCfg = js.config || lastCfg;
            $("#save_status").textContent = `Modus satt til ${newMode}`;
            // push umiddelbart til preview
            pushPreview();
            // radio-knappen i "Modus"-kortet holdes i sync:
            const radio = document.querySelector(`input[name=mode][value=${newMode}]`);
            if (radio) radio.checked = true;
          } catch (e) {
            $("#save_status").textContent = `Feil: kunne ikke sette modus (${e})`;
          } finally {
            setTimeout(() => ($("#save_status").textContent = ""), 3000);
          }
        }

        // -------- start/stopp varighet (uendret) --------
        async function startDuration(argMinutes) {
          const minutes =
            argMinutes != null ? Number(argMinutes) : parseInt(val("#start_minutes", "0"), 10);

          if (!Number.isFinite(minutes) || minutes <= 0) {
            alert("Ugyldig varighet");
            return;
          }
          const r = await fetch("/api/start-duration", {
            method: "POST",
            headers: headers(),
            body: JSON.stringify({ minutes }),
          });
          if (!r.ok) {
            alert(await r.text());
            return;
          }
          await loadAll();
        }
        // Stopp varighetsmodus (setter tilbake til daily p√• backend)
        async function stopDuration() {
          const r = await fetch("/api/stop", {
            method: "POST",
            headers: headers(),
          });
          if (!r.ok) {
            alert(await r.text());
            return;
          }
          await loadAll();
        }

        // -------- presets --------
        function applyPreset() {
          const p = val("#bg_preset", "none");
          if (p === "dark-solid") {
            ($(`input[name=bg_mode][value=solid]`) || {}).checked = true;
            $("#bg_solid_color") && ($("#bg_solid_color").value = "#0b0f14");
          } else if (p === "dark-grad") {
            ($(`input[name=bg_mode][value=gradient]`) || {}).checked = true;
            $("#bg_grad_from") && ($("#bg_grad_from").value = "#111827");
            $("#bg_grad_to") && ($("#bg_grad_to").value = "#0b0f14");
            $("#bg_grad_angle") && ($("#bg_grad_angle").value = 180);
          } else if (p === "photo-tint") {
            ($(`input[name=bg_mode][value=image]`) || {}).checked = true;
            $("#bg_img_url") && ($("#bg_img_url").value = "https://picsum.photos/1600/900");
            $("#bg_img_fit") && ($("#bg_img_fit").value = "cover");
            $("#bg_img_op") && ($("#bg_img_op").value = 1);
            $("#bg_img_tint") && ($("#bg_img_tint").value = "#000000");
            $("#bg_img_tint_op") && ($("#bg_img_tint_op").value = 0.4);
          }
          lock();
          updateDigitContrastHints();
          updateMessageContrastHints();
          pushPreview();
        }

        // -------- synk-pill --------
        async function updateSyncPill() {
          try {
            const r = await fetch("/debug/view-heartbeat");
            const js = await r.json();
            const hb = js.heartbeat || {};
            const age = hb.age_seconds ?? 9999;
            const viewRev = hb.rev || 0;
            const cfgRev = lastCfg && lastCfg._updated_at ? lastCfg._updated_at : 0;
            if (age > 30 || !hb.ts_iso) {
              pill && (pill.textContent = "Synk: visning offline");
              pill && (pill.className = "pill off");
            } else if (viewRev >= cfgRev) {
              pill && (pill.textContent = `Synk: OK (rev ${viewRev})`);
              pill && (pill.className = "pill ok");
            } else {
              pill && (pill.textContent = `Synk: venter (view ${viewRev} < cfg ${cfgRev})`);
              pill && (pill.className = "pill warn");
            }
          } catch {
            pill && (pill.textContent = "Synk: ‚Äî");
            pill && (pill.className = "pill off");
          }
        }

        // -------- events --------
        $$("input[name=mode]").forEach((el) => el.addEventListener("change", lock));
        $$("input[name=bg_mode]").forEach((el) =>
          el.addEventListener("change", () => {
            lock();
            updateDigitContrastHints();
            updateMessageContrastHints();
          }),
        );
        [
          "color_normal",
          "color_warn",
          "color_alert",
          "color_over",
          "theme_p_color",
          "theme_s_color",
        ].forEach((id) => {
          const e = document.getElementById(id);
          e &&
            e.addEventListener("input", () => {
              updateDigitContrastHints();
              updateMessageContrastHints();
            });
        });
        $$(".preset").forEach((b) =>
          b.addEventListener("click", async () => {
            const m = Number(b.dataset.min);
            const e = $("#start_minutes");
            if (e) e.value = String(m); // behold visuell verdi i feltet
            await startDuration(m); // üëâ start umiddelbart
          }),
        );
        $("#btn_apply_preset") && $("#btn_apply_preset").addEventListener("click", applyPreset);
        $("#btn_save") &&
          $("#btn_save").addEventListener("click", () => saveAll().catch((e) => alert(e.message)));
        $("#btn_refresh") &&
          $("#btn_refresh").addEventListener("click", () =>
            loadAll().catch((e) => alert(e.message)),
          );
        $("#btn_reset_view") &&
          $("#btn_reset_view").addEventListener("click", () =>
            fetchDefaults().then((d) => {
              const M = d.theme.messages,
                B = d.theme.background,
                D = d.theme.digits;
              $("#digits_size_preset") && ($("#digits_size_preset").value = String(D.size_vw));
              $("#theme_p_size") && ($("#theme_p_size").value = String(M.primary.size_rem));
              $("#theme_p_weight") && ($("#theme_p_weight").value = String(M.primary.weight));
              $("#theme_p_color") && ($("#theme_p_color").value = M.primary.color);
              $("#theme_s_size") && ($("#theme_s_size").value = String(M.secondary.size_rem));
              $("#theme_s_weight") && ($("#theme_s_weight").value = String(M.secondary.weight));
              $("#theme_s_color") && ($("#theme_s_color").value = M.secondary.color);
              ($(`input[name=bg_mode][value=${B.mode}]`) || {}).checked = true;
              $("#bg_solid_color") && ($("#bg_solid_color").value = B.solid.color);
              $("#bg_grad_from") && ($("#bg_grad_from").value = B.gradient.from);
              $("#bg_grad_to") && ($("#bg_grad_to").value = B.gradient.to);
              $("#bg_grad_angle") && ($("#bg_grad_angle").value = B.gradient.angle_deg);
              $("#bg_img_url") && ($("#bg_img_url").value = B.image.url);
              $("#bg_img_fit") && ($("#bg_img_fit").value = B.image.fit);
              $("#bg_img_op") && ($("#bg_img_op").value = B.image.opacity);
              $("#bg_img_tint") && ($("#bg_img_tint").value = B.image.tint.color);
              $("#bg_img_tint_op") && ($("#bg_img_tint_op").value = B.image.tint.opacity);
              lock();
              updateDigitContrastHints();
              updateMessageContrastHints();
            }),
          );
        $("#btn_start") &&
          $("#btn_start").addEventListener("click", () =>
            startDuration().catch((e) => alert(e.message)),
          );
        $("#btn_stop") &&
          $("#btn_stop").addEventListener("click", () =>
            stopDuration().catch((e) => alert(e.message)),
          );

        const clkColorEl = document.getElementById("clk_color");
        clkColorEl && clkColorEl.addEventListener("input", updateClockContrastHint);

        // N√•r bakgrunnsmodus/farger endres -> oppdater klokke-kontrast
        $$("input[name=bg_mode]").forEach((el) =>
          el.addEventListener("change", () => {
            lock();
            updateDigitContrastHints();
            updateMessageContrastHints();
            updateClockContrastHint();
          }),
        );
        [
          "#bg_solid_color",
          "#bg_grad_from",
          "#bg_grad_to",
          "#bg_img_tint",
          "#bg_img_tint_op",
        ].forEach((sel) => {
          const e = document.querySelector(sel);
          e && e.addEventListener("input", updateClockContrastHint);
        });

        // Egen-tekst toggle
        $("#clk_use_own_msgs") && $("#clk_use_own_msgs").addEventListener("change", lock);

        // Mode-knapper (Daglig/Klokke) i toppbaren
        $$(".mode-btn").forEach((b) => {
          b.addEventListener("click", () => patchMode(b.dataset.mode));
        });

        // Preset-knapper (15/20 min) i toppbaren
        $$(".mode-preset").forEach((b) => {
          b.addEventListener("click", async () => {
            const m = Number(b.dataset.min || "0");
            if (!Number.isFinite(m) || m <= 0) return;
            await startDuration(m); // start umiddelbart via /api/start-duration
            $("#save_status").textContent = `Startet ${m} min`;
            setTimeout(() => ($("#save_status").textContent = ""), 2000);
          });
        });

        // -------- init --------
        loadAll().catch(console.error);
        setInterval(updateSyncPill, 3000);
      })();
    </script>

    <!-- Fast forh√•ndsvisning p√• h√∏yre side -->
    <aside id="preview_dock" aria-label="Live forh√•ndsvisning">
      <iframe id="preview_frame" src="/?preview=1" title="Live preview" loading="eager"></iframe>
    </aside>
  </body>
</html>
