<!-- static/diag.html -->
<!doctype html>
<html lang="no">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Countdown · Diagnose</title>
   <link rel="stylesheet" href="/static/css/ui.css" />
    <link rel="stylesheet" href="/static/css/admin.css" />
    <style>
      /* Kun for diagnose: gjøre nedtelling mer synlig */
      .big {
        font-size: 8vh;
        line-height: 1.1;
        font-weight: 700;
      }
      .muted {
        opacity: 0.75;
      }
      .ok {
        color: #6dd96d;
      }
      .fail {
        color: #ff6b6b;
      }
      .grid {
        display: grid;
        gap: 1rem;
        grid-template-columns: 1fr;
      }
      @media (min-width: 960px) {
        .grid {
          grid-template-columns: 1fr 1fr;
        }
      }
      pre {
        max-height: 40vh;
        overflow: auto;
      }
      .chip {
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 4px 8px;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      }
      #selftest { list-style: none; padding: 0; margin: 0; }
#selftest li { 
  display:flex; align-items:center; gap:.5rem;
  padding:.4rem .6rem; border-radius:.6rem;
  background: var(--panel, #0e1320);
  border: 1px solid var(--border, #1c2436);
}
#selftest li.ok   { color:#9ef0a6; border-color:#275a32; background:#0e1a14; }
#selftest li.fail { color:#ff9ea1; border-color:#7a2d33; background:#2a1416; }

    </style>
  </head>
  <body class="admin">
    <header>
      <h1>Diagnose</h1>
      <nav>
        <a href="/">Visning</a>
        <a href="/admin">Admin</a>
        <a class="active" href="/diag">Diagnose</a>
        <a href="/about">Om</a>
      </nav>
    </header>

    <main class="grid">
      <section class="card">
        <h2>Nedtelling (live)</h2>
        <div id="countdown" class="big">00:00</div>
        <div id="phase" class="muted">fase: — · state: —</div>
        <div id="meta" class="muted">mål: — · nå: —</div>
        <div id="both" class="muted">format: — / —</div>
        <pre id="live" class="mono" style="margin-top: 0.5rem; max-height: 30vh; overflow: auto">(live)</pre>
        <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; align-items: center">
          <button id="refresh">Oppdater</button>
          <span id="lat" class="chip">latency: — ms</span>
        </div>
      </section>


      <section class="card">
        <h2>Debug</h2>
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.5rem">
          <button id="btn_who">/debug/whoami</button>
          <button id="btn_cfg">/api/config</button>
          <button id="btn_self">/debug/selftest</button>
          <button id="btn_hb">/debug/view-heartbeat</button>
        </div>
        <pre id="raw" class="mono">(tom)</pre>
      </section>

      <section class="card">
        <h2>Selvtest</h2>
        <p>Rask sanitetssjekk av kjerne-logikk (ikke pytest).</p>
        <ul id="selftest"></ul>
        <div style="margin-top: 0.5rem">
          <button id="run_selftest">Kjør selvtest</button>
        </div>
      </section>
     <section class="card">
  <h2>Kontroll</h2>
  <div style="display:flex;gap:.5rem;flex-wrap:wrap">
    <button data-sysctl data-action="restart-app">Restart app</button>
    <button data-sysctl data-action="restart-kiosk">Restart kiosk</button>
    <button data-sysctl data-action="reboot">Reboot RPi</button>
    <button data-sysctl data-action="shutdown">Shutdown RPi</button>
  </div>
</section>
    </main>

    <script>
      (function () {
        const fmtBoth = (ms) => {
          const sgn = ms < 0 ? "-" : "";
          ms = Math.abs(ms);
          let s = Math.floor(ms / 1000);
          const h = Math.floor(s / 3600);
          s %= 3600;
          const m = Math.floor(s / 60);
          s %= 60;
          const pad = (n) => String(n).padStart(2, "0");
          return {
            mmss: `${sgn}${Math.floor(h * 60 + m)}:${pad(s)}`,
            hms: `${sgn}${h}:${pad(m)}:${pad(s)}`,
          };
        };
        
        async function poll() {
          const t0 = performance.now();
          const r = await fetch("/tick");
          const t = await r.json();
          const dt = performance.now() - t0;
          const both = fmtBoth(t.signed_display_ms);
          document.getElementById("countdown").textContent = both.mmss;
          document.getElementById("phase").textContent = `fase: ${t.mode} · state: ${t.state}`;
          document.getElementById("meta").textContent =
            `mål: ${t.target_hhmm || t.target_ms} · nå: ${new Date(t.now_ms).toLocaleTimeString()}`;
          document.getElementById("both").textContent = `format: ${both.hms} / ${both.mmss}`;
          document.getElementById("lat").textContent = `latency: ${dt.toFixed(0)} ms`;
          document.getElementById("live").textContent = JSON.stringify(t, null, 2);
        }
        async function selftest() {
          const r = await fetch("/debug/selftest");
          const js = await r.json();
          const ul = document.getElementById("selftest");
          ul.innerHTML = "";
          js.tests.forEach((t) => {
            const li = document.createElement("li");
            li.textContent = `${t.ok ? "✔" : "✖"} ${t.name}${t.info ? " — " + t.info : ""}`;
            li.className = t.ok ? "ok" : "fail";
            ul.appendChild(li);
          });
        }
        async function dump(url) {
          const r = await fetch(url);
          const js = await r.json();
          document.getElementById("raw").textContent = JSON.stringify(js, null, 2);
        }

        document.getElementById("refresh").addEventListener("click", () => poll().catch(console.error));
        document.getElementById("run_selftest").addEventListener("click", () => selftest().catch(console.error));
        document.getElementById("btn_who").addEventListener("click", () => dump("/debug/whoami").catch(console.error));
        document.getElementById("btn_cfg").addEventListener("click", () => dump("/api/config").catch(console.error));
        document
          .getElementById("btn_self")
          .addEventListener("click", () => dump("/debug/selftest").catch(console.error));
        document
          .getElementById("btn_hb")
          .addEventListener("click", () => dump("/debug/view-heartbeat").catch(console.error));

        poll().catch(console.error);
        setInterval(poll, 1000);
      })();
      (function () {
  function readAdminPass() {
    const i = document.getElementById("admin-password");
    return (i && i.value) || localStorage.getItem("admin_password") || "";
  }
  async function doAction(act) {
    const r = await fetch("/api/system", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Admin-Password": readAdminPass()
      },
      body: JSON.stringify({ action: act })
    });
    const js = await r.json().catch(() => ({}));
    alert(js.ok ? `OK: ${act}` : `Feil: ${js.error || r.status}`);
  }
  document.querySelectorAll("[data-act]").forEach(btn => {
    btn.addEventListener("click", () => doAction(btn.dataset.act));
  });
})();

    </script>
  </body>
</html>
