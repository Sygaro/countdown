<!-- static/diag.html -->
<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Countdown · Diagnose</title>
  <link rel="stylesheet" href="/static/css/ui.css"/>
  <style>
    .big { font-size: 8vh; line-height: 1.1; font-weight: 700; }
  </style>
</head>
<body>
  <header>
    <h1>Diagnose</h1>
    <nav>
      <a href="/">Visning</a>
      <a href="/admin">Admin</a>
      <a class="active" href="/diag">Diagnose</a>
      <a href="/about">Om</a>
    </nav>
  </header>

  <main class="grid">
    <section class="card">
      <h2>Nedtelling (live)</h2>
      <div class="big" id="fmt_auto">00:00</div>
      <div class="muted" id="fmt_mmss">mm:ss — 00:00</div>
      <div class="muted" id="fmt_hms">h:mm:ss — 0:00:00</div>
      <div class="muted" id="phase">fase: — · state: —</div>
      <div class="muted" id="meta">mål: — · nå: —</div>
      <div style="margin-top:.5rem">
        <button id="refresh">Oppdater</button>
        <button id="selftest">Kjør selvtest</button>
      </div>
    </section>

    <section class="card">
      <h2>Rådata</h2>
      <pre id="raw">(tom)</pre>
    </section>

    <section class="card">
      <h2>Selvtest</h2>
      <ul id="tests"></ul>
    </section>
  </main>

  <script>
    (function(){
      const fmtMMSS = (ms)=>{ const sgn=ms<0?"-":""; ms=Math.abs(ms); let s=Math.floor(ms/1000), m=Math.floor(s/60); s%=60; const pad=n=>String(n).padStart(2,"0"); return `${sgn}${m}:${pad(s)}`; };
      const fmtHMS  = (ms)=>{ const sgn=ms<0?"-":""; ms=Math.abs(ms); let s=Math.floor(ms/1000), h=Math.floor(s/3600); s%=3600; const m=Math.floor(s/60); s%=60; const pad=n=>String(n).padStart(2,"0"); return `${sgn}${h}:${pad(m)}:${pad(s)}`; };

      async function poll(){
        const r=await fetch("/tick"); const t=await r.json();
        document.getElementById("fmt_auto").textContent = (Math.abs(t.signed_display_ms)>=3600*1000) ? fmtHMS(t.signed_display_ms) : fmtMMSS(t.signed_display_ms);
        document.getElementById("fmt_mmss").textContent = "mm:ss — " + fmtMMSS(t.signed_display_ms);
        document.getElementById("fmt_hms").textContent  = "h:mm:ss — " + fmtHMS(t.signed_display_ms);
        document.getElementById("phase").textContent    = `fase: ${t.mode} · state: ${t.state}`;
        document.getElementById("meta").textContent     = `mål: ${t.target_hhmm || t.target_ms} · nå: ${new Date(t.now_ms).toLocaleTimeString()}`;
        document.getElementById("raw").textContent      = JSON.stringify(t,null,2);
      }
      async function selftest(){
        const r=await fetch("/debug/selftest"); const js=await r.json();
        const ul=document.getElementById("tests"); ul.innerHTML="";
        js.tests.forEach(t=>{ const li=document.createElement("li"); li.textContent=`${t.ok?"✔":"✖"} ${t.name}${t.info?" — "+t.info:""}`; li.style.color=t.ok?"#69db7c":"#ff6b6b"; ul.appendChild(li); });
      }

      document.getElementById("refresh").addEventListener("click",()=>poll().catch(console.error));
      document.getElementById("selftest").addEventListener("click",()=>selftest().catch(console.error));
      poll().catch(console.error);
      setInterval(poll,1000);
    })();
  </script>
</body>
</html>
