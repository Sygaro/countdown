<!doctype html>
<html lang="nb">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Countdown – Diagnose</title>
  <style>
    :root{ --bg:#0b0b0f; --fg:#eaeaf0; --muted:#9aa0a6; --ok:#2ea043; --warn:#e6a700; --err:#d73a49; }
    *{box-sizing:border-box}
    body{margin:0;padding:1rem 1.25rem;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--fg)}
    h1{font-size:1.4rem;margin:.2rem 0 1rem}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    @media (max-width: 960px){ .grid{grid-template-columns:1fr} }
    section{border:1px solid #22262b;border-radius:12px;padding:1rem;background:#0f1116}
    section h2{font-size:1.05rem;margin:.2rem 0 .8rem;color:#cfd4d9}
    .row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    input,button,select{padding:.5rem .7rem;border-radius:10px;border:1px solid #30363d;background:#0d0f14;color:var(--fg)}
    button.primary{background:#2563eb;border-color:#2563eb}
    button.danger{background:#7f1d1d;border-color:#7f1d1d}
    .badge{display:inline-flex;align-items:center;gap:.4rem;padding:.2rem .55rem;border-radius:999px;border:1px solid #2a2f36;color:#cfd4d9}
    .dot{width:.6rem;height:.6rem;border-radius:50%}
    .ok{background:var(--ok)} .warn{background:var(--warn)} .err{background:var(--err)}
    pre{white-space:pre-wrap;word-break:break-word;background:#0b0d12;border:1px solid #22262b;border-radius:10px;padding:.6rem;max-height:40vh;overflow:auto}
    small{color:var(--muted)}
    .kv{display:grid;grid-template-columns:180px 1fr;gap:.35rem .75rem}
    .kv div.key{color:#cfd4d9}
  </style>
</head>
<body>
  <h1>Countdown – Diagnose</h1>

  <div class="grid">
    <section>
      <h2>Tilkobling</h2>
      <div class="kv">
        <div class="key">SSE</div><div><span id="sseBadge" class="badge"><span id="sseDot" class="dot err"></span><span id="sseTxt">frakoblet</span></span></div>
        <div class="key">Sist event</div><div id="lastEvt">–</div>
        <div class="key">/health</div><div><span id="healthTxt">–</span></div>
        <div class="key">Klokke-drift</div><div><span id="driftTxt">–</span> <small>(server_now_ms − client_now)</small></div>
      </div>
      <div class="row" style="margin-top:.6rem">
        <button id="btnPing">Ping /health</button>
        <button id="btnReloadState">Hent /state</button>
        <button id="btnReloadCfg">Hent /api/config</button>
      </div>
    </section>

    <section>
      <h2>Handlinger (krever passord hvis satt)</h2>
      <div class="row" style="margin-bottom:.6rem">
        <input id="pwd" type="password" placeholder="Admin-passord" style="min-width:200px" />
      </div>
      <div class="row" style="margin-bottom:.5rem">
        <input id="mins" type="number" min="1" step="1" value="5" style="width:7rem"/>
        <button id="btnStart" class="primary">Start nedtelling (min)</button>
        <input id="hhmm" type="time" />
        <button id="btnDaily">Sett daglig klokkeslett</button>
      </div>
      <div class="row">
        <button id="btnClearTarget" class="danger">Tøm engangs-tidspunkt</button>
      </div>
      <small id="actMsg"></small>
    </section>

    <section>
      <h2>State</h2>
      <pre id="statePre">(tom)</pre>
    </section>

    <section>
      <h2>Config</h2>
      <pre id="cfgPre">(tom)</pre>
    </section>
  </div>

  <script>
    const el = id => document.getElementById(id);
    const pretty = o => JSON.stringify(o, null, 2);
    const base = window.location.origin;

    let sseOK = false;
    let lastServerNow = null;

    function setSSE(ok){
      sseOK = !!ok;
      el('sseDot').className = 'dot ' + (ok? 'ok':'err');
      el('sseTxt').textContent = ok? 'tilkoblet' : 'frakoblet';
    }

    async function fetchJSON(url, opts={}){
      const r = await fetch(url, opts);
      if(!r.ok) throw new Error(await r.text());
      return r.json();
    }

    async function loadState(){
      const data = await fetchJSON(base + '/state', {cache:'no-store'});
      el('statePre').textContent = pretty(data);
      if (data.now_ms) { lastServerNow = data.now_ms; }
      return data;
    }

    async function loadConfig(){
      const data = await fetchJSON(base + '/api/config', {cache:'no-store'});
      el('cfgPre').textContent = pretty(data.config || data);
      if (data.state && data.state.now_ms){ lastServerNow = data.state.now_ms; }
      return data;
    }

    async function ping(){
      try{
        const r = await fetch(base + '/health', {cache:'no-store'});
        el('healthTxt').textContent = r.ok? 'OK' : ('HTTP ' + r.status);
      }catch(e){ el('healthTxt').textContent = 'Feil: ' + e.message; }
    }

    function startSSE(){
      try{
        const es = new EventSource(base + '/sse');
        es.onopen = () => setSSE(true);
        es.onerror = () => setSSE(false);
        es.onmessage = async ev => {
          try{
            const msg = JSON.parse(ev.data);
            el('lastEvt').textContent = new Date().toLocaleTimeString() + ' – ' + (msg.type||'event');
            // Oppdater state ved konfig-endring
            if (msg.type === 'config_update') {
              await loadState();
            }
          }catch(e){ /* ignore */ }
        };
      }catch(e){ setSSE(false); }
    }

    // Drift = server_now_ms - client_now
    setInterval(() => {
      if (lastServerNow){
        const drift = Math.round(lastServerNow - Date.now());
        const s = (drift>0? '+':'') + drift + ' ms';
        el('driftTxt').textContent = s;
      }
    }, 500);

    // --- Actions ---
    async function doStart(){
      const minutes = parseInt(el('mins').value, 10);
      const pwd = el('pwd').value.trim();
      try{
        const r = await fetch(base + '/api/start',{
          method:'POST',
          headers:{ 'Content-Type':'application/json', ...(pwd? {'X-Admin-Password': pwd} : {}) },
          body: JSON.stringify({ minutes })
        });
        if(!r.ok) throw new Error(await r.text());
        el('actMsg').textContent = 'Nedtelling startet ('+minutes+' min).';
      }catch(e){ el('actMsg').textContent = 'Feil: ' + e.message; }
    }

    async function doDaily(){
      const t = (el('hhmm').value||'').trim();
      const pwd = el('pwd').value.trim();
      if(!t){ el('actMsg').textContent = 'Oppgi HH:MM'; return; }
      try{
        const r = await fetch(base + '/api/config',{
          method:'POST',
          headers:{ 'Content-Type':'application/json', ...(pwd? {'X-Admin-Password': pwd} : {}) },
          body: JSON.stringify({ daily_time: t, target_datetime: "__clear__" })
        });
        if(!r.ok) throw new Error(await r.text());
        el('actMsg').textContent = 'Daglig tid satt til ' + t + ' (engangs-tidspunkt fjernet).';
      }catch(e){ el('actMsg').textContent = 'Feil: ' + e.message; }
    }

    async function doClearTarget(){
      const pwd = el('pwd').value.trim();
      try{
        const r = await fetch(base + '/api/config',{
          method:'POST',
          headers:{ 'Content-Type':'application/json', ...(pwd? {'X-Admin-Password': pwd} : {}) },
          body: JSON.stringify({ target_datetime: "__clear__" })
        });
        if(!r.ok) throw new Error(await r.text());
        el('actMsg').textContent = 'Engangs-tidspunkt fjernet.';
      }catch(e){ el('actMsg').textContent = 'Feil: ' + e.message; }
    }

    // Bind
    el('btnPing').addEventListener('click', ping);
    el('btnReloadState').addEventListener('click', loadState);
    el('btnReloadCfg').addEventListener('click', loadConfig);
    el('btnStart').addEventListener('click', doStart);
    el('btnDaily').addEventListener('click', doDaily);
    el('btnClearTarget').addEventListener('click', doClearTarget);

    // Init
    (async () => {
      await ping();
      await loadConfig();
      await loadState();
      startSSE();
    })();
  </script>
</body>
</html>