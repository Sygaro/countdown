<!-- static/index.html -->
<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Countdown · Visning</title>
  <link rel="stylesheet" href="/static/css/ui.css"/>
</head>
<body class="center fill">
  <button id="btn_fullscreen" class="fs-btn" title="Fullskjerm">⛶ Fullskjerm</button>

  <div id="view_countdown" class="center fill" style="flex-direction:column;gap:2vh;display:none">
    <div id="msgs_above" class="muted" style="display:none;text-align:center">
      <div id="msg_primary_above"></div>
      <div id="msg_secondary_above"></div>
    </div>

    <div id="digits" class="big">00:00</div>

    <div id="msgs_below" class="muted" style="display:none;text-align:center">
      <div id="msg_primary_below"></div>
      <div id="msg_secondary_below"></div>
    </div>
  </div>

  <div id="view_screen" class="screen" style="display:none">
    <div id="screen_inner"></div>
  </div>

  <script>
    (function(){
      const $ = (s)=>document.querySelector(s);
      const state = { cfg:null, tick:null, lastCfgRev:0 };
      let lastActivityTs = Date.now();

      function fmtMMSS(ms){
        const neg = ms < 0 ? "-" : "";
        ms = Math.abs(ms);
        const total = Math.floor(ms/1000);
        const m = Math.floor(total/60);
        const s = total % 60;
        return `${neg}${m}:${String(s).padStart(2,"0")}`;
      }
      function fmtHMS(ms){
        const neg = ms < 0 ? "-" : "";
        ms = Math.abs(ms);
        const total = Math.floor(ms/1000);
        const h = Math.floor(total/3600);
        const rem = total % 3600;
        const m = Math.floor(rem/60);
        const s = rem % 60;
        const pad = (n)=>String(n).padStart(2,"0");
        return `${neg}${h}:${pad(m)}:${pad(s)}`;
      }

      function applyCountdown(){
        const t = state.tick, c = state.cfg;
        $("#view_screen").style.display = "none";
        $("#view_countdown").style.display = "flex";

        const thresholdMs = (c.hms_threshold_minutes ?? 60) * 60 * 1000;
        const msActive = (t.state === "countdown" || t.state === "overrun");
        const ms = msActive ? t.signed_display_ms : 0;

        const useHMS = Math.abs(ms) >= thresholdMs;
        const digits = $("#digits");
        digits.textContent = useHMS ? fmtHMS(ms) : fmtMMSS(ms);

        let color = c.color_normal;
        if (c.use_phase_colors) {
          if (t.state === "overrun" || t.signed_display_ms < 0) {
            color = c.color_over || c.color_alert;
          } else if (t.mode === "alert") {
            color = c.color_alert;
          } else if (t.mode === "warn") {
            color = c.color_warn;
          }
        }
        digits.style.color = color;
        digits.classList.toggle("blink", !!(c.use_blink && t.blink));

        const targetText = (c.show_target_time && t.target_hhmm) ? ` ${t.target_hhmm}` : "";
        const prim = (c.show_message_primary ? (c.message_primary||"") : "") + ((c.target_time_after==="primary") ? targetText : "");
        const sec  = (c.show_message_secondary ? (c.message_secondary||"") : "") + ((c.target_time_after==="secondary") ? targetText : "");

        const above = c.messages_position === "above";
        $("#msgs_above").style.display = above ? "block" : "none";
        $("#msgs_below").style.display = above ? "none"  : "block";
        $("#msg_primary_above").textContent   = above ? prim : "";
        $("#msg_secondary_above").textContent = above ? sec  : "";
        $("#msg_primary_below").textContent   = !above ? prim : "";
        $("#msg_secondary_below").textContent = !above ? sec  : "";
      }

      function applyScreen(){
        const sc = state.cfg.screen || {};
        $("#view_countdown").style.display = "none";
        $("#view_screen").style.display = "flex";
        const root = $("#view_screen");
        root.style.background = sc.bg || "#000";
        const inner = $("#screen_inner");
        inner.innerHTML = "";
        if (sc.type === "blackout") return;
        if (sc.type === "image") {
          const wrap = document.createElement("div");
          wrap.style.position="relative"; wrap.style.width="100%"; wrap.style.height="100%";
          const img = document.createElement("img");
          img.src = sc.image_url || "";
          img.style.objectFit = sc.image_fit || "cover";
          img.style.width="100%"; img.style.height="100%";
          img.style.opacity = String((sc.image_opacity ?? 100)/100);
          wrap.appendChild(img);
          inner.appendChild(wrap);
          return;
        }
        const div = document.createElement("div");
        div.className = "text";
        div.textContent = sc.text || "Pause";
        div.style.color = sc.text_color || "#fff";
        div.style.fontSize = `${Math.max(4, Math.min(30, Number(sc.font_vh ?? 10)))}vh`;
        inner.appendChild(div);
      }

      async function fetchConfig(){
        const r = await fetch("/api/config"); const js = await r.json();
        state.cfg = js.config; state.lastCfgRev = js.config._updated_at || 0;
        sendHeartbeat();
      }
      async function firstLoad(){
        await fetchConfig();
        const r = await fetch("/tick"); state.tick = await r.json();
        render();
        sendHeartbeat();
      }
      async function pollTick(){
        const r = await fetch("/tick"); const t = await r.json();
        state.tick = t;
        if ((t.cfg_rev||0) !== state.lastCfgRev) {
          await fetchConfig();
        }
        render(true);
      }

      function render(){
        const mode = (state.cfg?.mode) || "daily";
        if (mode === "screen") applyScreen(); else applyCountdown();
      }

      // --- Heartbeat til admin ---
      function sendHeartbeat(){
        const payload = JSON.stringify({ rev: state.lastCfgRev, page: "view" });
        if (navigator.sendBeacon) {
          const blob = new Blob([payload], {type: "application/json"});
          navigator.sendBeacon("/debug/view-heartbeat", blob);
        } else {
          // fallback
          fetch("/debug/view-heartbeat", {method:"POST", headers:{"Content-Type":"application/json"}, body: payload})
            .catch(()=>{});
        }
      }
      setInterval(sendHeartbeat, 10000);

      // --- Fullscreen + auto-skjul ---
      const fsBtn = $("#btn_fullscreen");
      function showFsBtn(){ fsBtn.style.display = (document.fullscreenEnabled ? "inline-block" : "none"); fsBtn.style.opacity = "1"; }
      function hideFsBtn(){ if (document.fullscreenEnabled) fsBtn.style.opacity = "0"; }
      function bumpActivity(){ lastActivityTs = Date.now(); showFsBtn(); }
      ["mousemove","mousedown","keydown","touchstart"].forEach(ev => document.addEventListener(ev, bumpActivity, {passive:true}));
      setInterval(()=>{ if (Date.now()-lastActivityTs > 5000) hideFsBtn(); }, 1000);

      fsBtn.addEventListener("click", async () => {
        try {
          if (!document.fullscreenElement) await document.documentElement.requestFullscreen();
          else await document.exitFullscreen();
        } catch (e) { console.error(e); }
      });

      // boot
      showFsBtn();
      firstLoad().catch(console.error);
      setInterval(pollTick, 1000);
    })();
  </script>
</body>
</html>
